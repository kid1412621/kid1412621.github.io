---
title: Java 9 åˆ° 21 çš„è¯­è¨€ç‰¹æ€§æ›´æ–°
date: 2025-03-25
tags:
  - backend
  - java
  - translation
---

å½“ Java 8 å¼•å…¥æµå’Œ Lambda è¿™ä¸¤ä¸ªé‡å¤§æ›´æ–°æ—¶ï¼Œå‡½æ•°å¼ç¼–ç¨‹é£æ ¼èµ‹äºˆäº† Java æ›´å°‘æ¨¡æ¿ä»£ç çš„è¯­æ³•ã€‚è‡ªä» Java åˆ‡æ¢åˆ°ä¸€ä¸ªæ›´å¿«çš„å‘å¸ƒèŠ‚å¥åï¼Œæ¯å…­ä¸ªæœˆå°±ä¼šå‘å¸ƒä¸€ä¸ªæ–°ç‰ˆæœ¬ã€‚è®°å½•ç±»å¯èƒ½æ˜¯æœ€è¿‘æ›´æ–°ä¸­æœ€é‡è¦çš„ä¸€ä¸ªç‰¹æ€§ï¼Œæ¨¡å¼åŒ¹é…å’Œå°é—­ç±»ä¹Ÿä¼šè®©å¤„ç†çº¯æ•°æ®æ›´å®¹æ˜“ã€‚

---

> æœ¬è¯‘æ–‡å·²è·å–ä½œè€…è®¸å¯åç¿»è¯‘ã€è°ƒæ•´ã€å‘å¸ƒã€‚
>
> åŸæ–‡ï¼š[New language features since Java 8 to 21ï¼ˆEnhancements to the Java language you should knowï¼‰](https://advancedweb.hu/new-language-features-since-java-8)
>
> æ­¤å¤–ï¼ŒOracle å®˜æ–¹ä¹Ÿæœ‰æ¸…å•å¯ä¾›ä¸€è§ˆï¼š[Java Language Changes](https://docs.oracle.com/javase/specs/index.html)


## ç›®å½•

**Java 21** (LTS)

- [switch æ¨¡å¼åŒ¹é…](#Switch-æ¨¡å¼åŒ¹é…)
- [è®°å½•æ¨¡å¼ (Record Patterns)](#è®°å½•æ¨¡å¼)
- [åŒ¿åæ¨¡å¼å’ŒåŒ¿åå˜é‡](#åŒ¿åæ¨¡å¼å’ŒåŒ¿åå˜é‡) (é¢„è§ˆç‰¹æ€§ ğŸ”)
- [å­—ç¬¦ä¸²æ¨¡ç‰ˆ](#å­—ç¬¦ä¸²æ¨¡ç‰ˆ) (é¢„è§ˆç‰¹æ€§ ğŸ”)
- [åŒ¿åç±»å’Œå®ä¾‹ä¸»æ–¹æ³•](#åŒ¿åç±»å’Œå®ä¾‹ä¸»æ–¹æ³•) (é¢„è§ˆç‰¹æ€§ ğŸ”)

**Java 17** (LTS)

- [å°é—­ç±» (Sealed Classes)](#å°é—­ç±»)
  - [æç¤ºï¼šè€ƒè™‘ä½¿ç”¨å°é—­ç±»è€Œéæšä¸¾](#tip-consider-sealed-classes-vs-enums)

**Java 16**

- [è®°å½•ç±» (Record Classes)](#è®°å½•ç±»)
  - [æç¤ºï¼šä½¿ç”¨æœ¬åœ°è®°å½•ç±»æ¥æ„å»ºä¸­é—´è½¬åŒ–å˜é‡](#tip-use-local-records-to-model-intermediate-transformations)
  - [æç¤ºï¼šæ£€æŸ¥ä½ ç”¨çš„ç±»åº“](#tip-check-your-libraries)
- [instanceof æ¨¡å¼åŒ¹é…](#instanceof-æ¨¡å¼åŒ¹é…)

**Java 15**

- [æ–‡æœ¬å—](#æ–‡æœ¬å—)
  - [æç¤ºï¼šä¿ç•™ç»“å°¾ç©ºæ ¼](#tip-preserve-trailing-spaces)
  - [æç¤ºï¼šæ­£ç¡®å¤„ç† Windows çš„æ¢è¡Œç¬¦](#tip-produce-the-correct-newline-charactors-for-windows)
  - [æç¤ºï¼šå…³æ³¨ç¼©è¿›çš„ä¸€è‡´æ€§](#tip-pay-attention-to-consistent-indentation)
- [åŒ…å«æœ‰ç”¨ä¿¡æ¯çš„ç©ºæŒ‡é’ˆå¼‚å¸¸](#åŒ…å«æœ‰ç”¨ä¿¡æ¯çš„ç©ºæŒ‡é’ˆå¼‚å¸¸)
  - [æç¤ºï¼šæ£€æŸ¥ä½ çš„å·¥å…·é“¾](#tip-check-your-tooling)

**Java 14**

- [Switch è¡¨è¾¾å¼](#switch-è¡¨è¾¾å¼)
  - [æç¤ºï¼šä½¿ç”¨ç®­å¤´è¯­æ³•](#tip-use-arrow-syntax)

**Java 11** (LTS)

- [å±€éƒ¨å˜é‡ç±»å‹æ¨æ–­](#å±€éƒ¨å˜é‡ç±»å‹æ¨æ–­)
  - [æç¤ºï¼šæ—¶åˆ»è€ƒè™‘å¯è¯»æ€§](#tip-keep-readability-in-mind)
  - [æç¤ºï¼šæ³¨æ„ä¿ç•™é‡è¦çš„ç±»å‹ä¿¡æ¯](#tip-pay-attention-to-preserve-important-type-infomation)
  - [æç¤ºï¼šç¡®ä¿é˜…è¯»å®˜æ–¹çš„ä»£ç é£æ ¼æŒ‡å—](#tip-make-sure-to-read-the-official-style-guides)

**Java 9**

- [æ¥å£ä¸­å…è®¸ç§æœ‰æ–¹æ³•](#æ¥å£ä¸­å…è®¸ç§æœ‰æ–¹æ³•)
- [åŒ¿åå†…éƒ¨ç±»çš„é’»çŸ³æ“ä½œç¬¦](#åŒ¿åå†…éƒ¨ç±»çš„é’»çŸ³æ“ä½œç¬¦)
- [try-with-resources è¯­å¥ä¸­å…è®¸ä½¿ç”¨ effectively-final å˜é‡](#try-with-resources-è¯­å¥ä¸­å…è®¸ä½¿ç”¨-effectively-final-å˜é‡)
  - [æç¤ºï¼šå½“å¿ƒå·²é‡Šæ”¾çš„èµ„æº](#tip-watch-out-for-released-resources)
- [ä¸‹åˆ’çº¿ä¸å†æ˜¯åˆæ³•å˜é‡å](#ä¸‹åˆ’çº¿ä¸å†æ˜¯åˆæ³•å˜é‡å)
- [æ”¹è¿›çš„è­¦å‘Š](#æ”¹è¿›çš„è­¦å‘Š)

æƒ³è¦ä¸€è§ˆå¡‘é€ è¿™ä¸ªæ–°å¹³å°æ‰€æœ‰çš„ JEP[^1]ï¼Œå…¶æ¶µç›–äº†åŒ…æ‹¬ API ã€æ€§èƒ½ä¸å®‰å…¨æ–¹é¢çš„æ”¹è¿›ï¼Œå‚çœ‹è¿™ä»½[ç²¾é€‰æ¸…å•ï¼šJava 8 ä»¥æ¥æ‰€æœ‰çš„æ”¹è¿›](https://advancedweb.hu/a-categorized-list-of-all-java-and-jvm-features-since-jdk-8)[^2]ã€‚


## switch æ¨¡å¼åŒ¹é…

**å¼€å§‹æ”¯æŒç‰ˆæœ¬ï¼š**[`JDK 21`](https://openjdk.java.net/jeps/441)  ( [`JDK 18`](https://openjdk.java.net/jeps/420)  [`JDK 19`](https://openjdk.java.net/jeps/427) [`JDK 20`](https://openjdk.java.net/jeps/433) ä¸ºé¢„è§ˆç‰¹æ€§)


æ­¤å‰ï¼Œ`switch` è¡¨è¾¾å¼çš„ç”¨æ³•ååˆ†å±€é™ï¼šæ¡ä»¶ä»…ä»…æ”¯æŒå®Œå…¨ç›¸ç­‰çš„æƒ…å†µï¼Œè€Œä¸”åªæ”¯æŒå¾ˆå°‘å‡ ç±»ç±»å‹ï¼šæ•°å€¼ã€æšä¸¾ç±»å’Œå­—ç¬¦ä¸²ã€‚

è¿™ä¸ªé¢„è§ˆç‰¹æ€§å¢å¼ºäº† `swith` è¡¨è¾¾å¼çš„ç”¨æ³•ï¼Œ**å¯ä»¥ç”¨åœ¨ä»»æ„çš„ç±»å‹ä¸Šï¼ŒåŒ¹é…æ›´å¤æ‚çš„æ¨¡å¼**ã€‚

è¿™äº›æ–°ç‰¹æ€§æ˜¯**å‘åå…¼å®¹çš„**ï¼Œ`switch` æ­é…ä¼ ç»Ÿçš„å¸¸é‡å°±å¦‚ä»¥å¾€ä¸€æ ·çš„ä½¿ç”¨ï¼Œä¾‹å¦‚å’Œæšä¸¾å€¼ï¼š

```java
var symbol = switch (expression) {
  case ADDITION       -> "+";
  case SUBTRACTION    -> "-";
  case MULTIPLICATION -> "*";
  case DIVISION       -> "/";
};
```

ç„¶è€Œï¼Œéšç€ [JEP 394: Pattern Matching for instanceof](https://openjdk.java.net/jeps/394) çš„å¼•å…¥ï¼Œç°åœ¨å¯ä»¥å’Œç±»å‹æ¨¡å¼æ­é…ä½¿ç”¨ï¼š

```java
return switch (expression) {
  case Addition expr       -> "+";
  case Subtraction expr    -> "-";
  case Multiplication expr -> "*";
  case Division expr       -> "/";
};
```

æ¨¡å¼è¿˜æ”¯æŒ**å«è¯­å¥**[^3]ï¼Œå†™æ³•ä¸º`type pattern && guard expression`ï¼š

```java
String formatted = switch (o) {
    case Integer i && i > 10 -> String.format("a large Integer %d", i);
    case Integer i           -> String.format("a small Integer %d", i);
    default                  -> "something else";
};
```

è¿™å’Œä½¿ç”¨ `if` å£°æ˜çš„ç±»å‹æ¨¡å¼æ„æˆäº†å¾ˆå¥½çš„å¯¹ç§°æ€§ï¼Œå› ä¸ºç±»ä¼¼çš„æ¨¡å¼å¯ä»¥ç”¨äºæ¡ä»¶è¯­å¥ï¼š

```java
if (o instanceof Integer i && i > 10) {
  return String.format("a large Integer %d", i);
} else if (o instanceof Integer i) {
  return String.format("a large Integer %d", i);
} else {
  return "something else";
}
```

ä¸ `if` æ¡ä»¶ç±»ä¼¼ï¼Œ**æ¨¡å¼å˜é‡çš„ä½œç”¨åŸŸæ˜¯åˆ†æ”¯æ•æ„Ÿçš„**ï¼ˆflow sensitiveï¼‰ã€‚æ¯”å¦‚ï¼Œåœ¨ä¸‹é¢çš„æ¡ä»¶ä¸­ï¼Œå˜é‡ `i` çš„ä½œç”¨åŸŸä¸ºå«è¯­å¥åŠå…¶å³è¾¹çš„è¡¨è¾¾å¼ã€‚

```java
case Integer i && i > 10 -> String.format("a large Integer %d", i);
```

æ€»ä½“æ¥è¯´ï¼Œæ¨¡å¼åŒ¹é…ä¼šæŒ‰ä½ æœŸå¾…çš„é‚£æ ·å·¥ä½œï¼Œä½†å…¶ä¸­æ¶‰åŠäº†å¾ˆå¤šè§„åˆ™å’Œè¾¹ç¼˜æƒ…å†µã€‚å¦‚æœä½ æ„Ÿå…´è¶£ï¼Œæˆ‘æ¨èä½ è¯»ä¸‹ç›¸å…³çš„ JEPs æˆ–æ˜¯çœ‹ä¸‹  [Pattern matching for instanceof](#instanceof-æ¨¡å¼åŒ¹é…)  ç« èŠ‚ã€‚

**Switch ç°åœ¨ä¹Ÿèƒ½åŒ¹é… `null` å€¼**ã€‚é€šå¸¸æ¥è¯´ï¼Œå½“ `null` å€¼ä¼ ç»™ `switch` ä¼šæŠ¥ `NullPointerException`ã€‚å½“ä¸€ä¸ªå¸¸é‡è¯•å›¾åŒ¹é… `null` çš„æ—¶å€™ä¹Ÿä¼šå‡ºç°è¿™ç§æƒ…å†µã€‚ç„¶è€Œï¼Œç°åœ¨å¯ä»¥æ˜¾ç¤ºå¾—å£°æ˜ `null` åœ¨åˆ†æ”¯ä¸Šï¼š

```java
switch (s) {
  case null  -> System.out.println("Null");
  case "Foo" -> System.out.println("Foo");
  default    -> System.out.println("Something else");
}
```

Switch è¡¨è¾¾å¼éœ€è¦æ˜¯è¯¦å°½çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¿…é¡»è¦†ç›–æ‰€æœ‰çš„å¯èƒ½çš„è¾“å…¥ã€‚è¿™ä¹ŸåŒæ ·é€‚ç”¨äºæ¨¡å¼åŒ¹é…ï¼Œ**å½“ `switch` è¡¨è¾¾å¼æ²¡æœ‰å®Œå…¨è¦†ç›–å„ç§æƒ…å†µåˆ†æ”¯ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚**

```java
Object o = 1234;

// OK
String formatted = switch (o) {
    case Integer i           -> String.format("a small Integer %d", i);
    default                  -> "something else";
};

// ç¼–è¯‘é”™è¯¯ - 'switch' è¡¨è¾¾å¼æ²¡æœ‰æ¶µç›–æ‰€æœ‰å¯èƒ½çš„è¾“å…¥å€¼
// å› ä¸º o æ˜¯ object ç±»å‹ï¼ŒåŠ ä¸Š default case å¯ä»¥ä¿®å¤
String formatted = switch (o) {
    case Integer i           -> String.format("a small Integer %d", i);
};
```

æ­¤ç‰¹æ€§åŒ**æšä¸¾ï¼Œ[å°é—­ç±»](#å°é—­ç±»)å’Œæ³›æ€§èƒ½å¾ˆå¥½çš„åä½œ**ã€‚å¦‚æœåªæœ‰ä¸€ç»„å›ºå®šçš„åˆ†æ”¯å­˜åœ¨ï¼Œåˆ™å¯ä»¥çœç•¥é»˜è®¤åˆ†æ”¯ã€‚æ­¤å¤–ï¼Œæ­¤åŠŸèƒ½**åœ¨æ‰©å±•åŸŸçš„æ—¶å€™å¯¹ç»´æŠ¤ä»£ç åº“çš„å®Œæ•´æ€§æœ‰å¾ˆå¤§å¸®åŠ©**â€”â€”ä¾‹å¦‚ï¼Œåœ¨æšä¸¾ä¸­æœ‰ä¸€ä¸ªæ–°çš„å¸¸é‡ã€‚ç”±äºå®Œæ•´æ€§æ£€æŸ¥ï¼Œæ‰€æœ‰ç¼ºå¤±é»˜è®¤åˆ†æ”¯çš„ switch çš„è¡¨è¾¾å¼éƒ½ä¼šäº§ç”Ÿç¼–è¯‘å™¨é”™è¯¯ã€‚è¿™æ˜¯[JEP](https://openjdk.java.net/jeps/441)ä¸­çš„å¦ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼š

```java
sealed interface I<T> permits A, B {}
final class A<X> implements I<String> {}
final class B<Y> implements I<Y> {}

static int testGenericSealedExhaustive(I<Integer> i) {
    return switch (i) {
        case B<Integer> bi -> 42;
    };
}
```

è¿™æ®µä»£ç èƒ½é€šè¿‡ç¼–è¯‘æ˜¯å› ä¸ºç¼–è¯‘å™¨å¯ä»¥æ£€æµ‹åˆ°åªæœ‰ `A` å’Œ `B` æ˜¯ `I` çš„æœ‰æ•ˆå­ç±»å‹ï¼Œå¹¶ä¸”ç”±äºæ³›æ€§å‚æ•° `Integer`ï¼Œè¯¥å‚æ•°åªèƒ½æ˜¯ `B<Integer>` çš„å®ä¾‹ã€‚

åˆ†æ”¯çš„è¯¦å°½æ€§**æ£€æŸ¥æ˜¯åœ¨ç¼–è¯‘æ—¶**ï¼Œä½†å¦‚æœåœ¨è¿è¡Œæ—¶æœ‰æ–°çš„å®ç°ï¼ˆä¾‹å¦‚æ¥è‡ªå•ç‹¬çš„ç¼–è¯‘ï¼‰ï¼Œç¼–è¯‘å™¨è¿˜ä¼šæ’å…¥ä¸€ä¸ªé»˜è®¤åˆ†æ”¯å»æŠ›å‡º `MatchException`ã€‚

ç¼–è¯‘å™¨è¿˜æ‰§è¡Œä¸è¯¦å°½æ€§æ£€æŸ¥ç›¸åçš„æ“ä½œï¼š**å½“ä¸€ä¸ªåˆ†æ”¯å®Œå…¨æ¶µç›–å¦ä¸€ä¸ªåˆ†æ”¯æ—¶ï¼Œä¼šæŠ¥å‡ºç¼–è¯‘é”™è¯¯**ã€‚

```java
Object o = 1234;

// ç¼–è¯‘é”™è¯¯ - ç¬¬äºŒä¸ªæ¡ä»¶å·²åŒ…å«åœ¨ç¬¬ä¸€ä¸ªæ¡ä»¶åˆ†æ”¯ä¸­
String formatted = switch (o) {
    case Integer i           -> String.format("a small Integer %d", i);
    case Integer i && i > 10 -> String.format("a large Integer %d", i);
    default                  -> "something else";
};
```

å¦‚æœæ‰€æœ‰å¯èƒ½çš„ç±»å‹éƒ½è¢«å¤„ç†ï¼Œè¿™å…è®¸é»˜è®¤åˆ†æ”¯èƒ½æŠ¥å‡ºç¼–è¯‘æ—¶é”™è¯¯ã€‚

å‡ºäºå¯è¯»æ€§çš„åŸå› ï¼Œç¼–è¯‘å™¨æ£€æŸ¥ä¼š**å¼ºåˆ¶å°†å¸¸é‡åˆ†æ”¯æ”¾åœ¨ç›¸åº”åŸºäºç±»å‹çš„åˆ†æ”¯ä¹‹å‰**ã€‚ç›®æ ‡æ˜¯å§‹ç»ˆå…ˆæœ‰æ›´å…·ä½“çš„åˆ†æ”¯æ¡ä»¶ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç ç‰‡æ®µä¸­çš„åˆ†æ”¯ï¼Œä»…åœ¨ä»¥è¿™ä¸ªç¡®åˆ‡çš„é¡ºåºä¸‹æœ‰æ•ˆã€‚å¦‚æœå°è¯•é‡æ–°æ’åˆ—ï¼Œå°†æ”¶åˆ°ç¼–è¯‘é”™è¯¯ã€‚

```java
switch(num) {
    case -1, 1 -> "special case";
    case Integer i && i > 0 -> "positive number";
    case Integer i -> "other integer";
}
```

å‚è€ƒæ¥æº[^5]ï¼š
- [Inside Java Podcast Episode 17 â€œPattern Matching for switchâ€ with Gavin Bierman](https://inside.java/2021/06/13/podcast-017/)
- [Inside Java Podcast Episode 26: â€œJava 19 is Here!â€ with Brian Goetz and Ron Pressler](https://inside.java/2022/09/20/podcast-026/)
- [Inside Java Podcast Episode 28: â€œJava Language - State of the Unionâ€ with Gavin Bierman](https://inside.java/2022/12/23/podcast-028/)


## è®°å½•æ¨¡å¼
TBD


## åŒ¿åæ¨¡å¼å’ŒåŒ¿åå˜é‡
TBD


## å­—ç¬¦ä¸²æ¨¡ç‰ˆ
TBD


## åŒ¿åç±»å’Œå®ä¾‹ä¸»æ–¹æ³•
TBD


## å°é—­ç±»

**å¼€å§‹æ”¯æŒç‰ˆæœ¬ï¼š** [`JDK 17`](https://openjdk.java.net/jeps/409) ( [`JDK 15`](https://openjdk.java.net/jeps/360)  [`JDK 16`](https://openjdk.java.net/jeps/397) ä¸ºé¢„è§ˆç‰¹æ€§)

å°é—­ç±»ç”¨äºé™å®šå“ªäº›ç±»æˆ–æ¥å£å¯ä»¥è¢«ç”¨äºç»§æ‰¿æˆ–å®ç°å®ƒä»¬ã€‚è¿™ç»™è®¾è®¡å…¬å…± API å’Œæ›¿æ¢æšä¸¾æ¥æ„å»ºå›ºå®šæ•°é‡çš„å¯é€‰é¡¹ï¼Œæä¾›äº†ä¸€ä¸ªæ›´å¥½çš„å·¥å…·ã€‚

è€ç‰ˆæœ¬çš„ Java ä¹Ÿæä¾›äº†ä¸€äº›æœºåˆ¶æ¥å®ç°ç±»ä¼¼çš„æ•ˆæœã€‚æ ‡è®°ä¸º `final` çš„ç±»ä¸å…è®¸è¢«ç»§æ‰¿ï¼Œé…åˆè®¿é—®ä¿®é¥°ç¬¦å°±èƒ½ç¡®ä¿ä»…åŒä¸€åŒ…ä¸­çš„ç±»æ‰èƒ½ç»§æ‰¿ã€‚

åœ¨æ­¤ä¹‹ä¸Šï¼Œ*å°é—­ç±»*æä¾›äº†æ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œè®©å¼€å‘è€…èƒ½æ˜¾å¼åœ°åˆ—ä¸¾å…¶å­ç±»ã€‚

```java
public sealed class Shape
    permits Circle, Quadrilateral {...}
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè¢«å…è®¸ç»§æ‰¿ `Shape` ç±»çš„åªæœ‰ `Circle` å’Œ `Quadrilateral` ç±»ã€‚å®é™…ä¸Šï¼Œ*permits* è¿™ä¸ªå…³é”®å­—æœ‰äº›æ­§ä¹‰ï¼Œå› ä¸ºå®ƒä¸æ­¢æœ‰å…è®¸çš„å«ä¹‰ï¼Œå…¶**è¦æ±‚åˆ—ä¸¾çš„ç±»ç›´æ¥ç»§æ‰¿å°é—­ç±»**ã€‚

æ­¤å¤–ï¼Œæ­£å¦‚äººä»¬æ‰€æœŸæœ›çš„é‚£æ ·ï¼Œå¦‚æœ**ä»»ä½•å…¶å®ƒçš„ç±»è¯•å›¾ç»§æ‰¿è¿™ä¸ªå°é—­ç±»ï¼Œéƒ½ä¼šå‡ºç°ç¼–è¯‘é”™è¯¯**ã€‚

ç»§æ‰¿å°é—­ç±»çš„ç±»éœ€è¦ç¬¦åˆä¸€äº›è§„åˆ™ã€‚

**å¼€å‘è€…è¢«å¼ºåˆ¶æ¯æ¬¡éƒ½éœ€è¦æ˜¾å¼å®šä¹‰å‡ºå°é—­ç±»ç»§æ‰¿çš„è¾¹ç•Œ**ï¼Œé€šè¿‡æ·»åŠ ä»»æ„ä¸€ä¸ªä¸‹é¢ä¿®é¥°ç¬¦åˆ°è¢«å…è®¸çš„å­ç±»ä¸Šæ¥å®ç°ï¼š

- `final`: å­ç±»ä¸èƒ½ç»§æ‰¿
- `sealed`: å­ç±»ä»…èƒ½ç»§æ‰¿è¢«å…è®¸çš„ç±»
- `non-sealed`: å­ç±»èƒ½ä»»æ„ç»§æ‰¿

å› ä¸ºå­ç±»æœ¬èº«ä¹Ÿå¯ä»¥æ˜¯å°é—­çš„ï¼Œè¿™å°±æ„å‘³ç€å¯ä»¥å®šä¹‰**æ•´æ¡ç»§æ‰¿é“¾åŒ…å«é™å®šçš„å¯é€‰é¡¹**ï¼š

```java
public sealed class Shape
    permits Circle, Quadrilateral, WeirdShape {...}

public final class Circle extends Shape {...}

public sealed class Quadrilateral extends Shape
    permits Rectangle, Parallelogram {...}
public final class Rectangle extends Quadrilateral {...}
public final class Parallelogram extends Quadrilateral {...}

public non-sealed class WeirdShape extends Shape {...}
```

```mermaid
classDiagram
  Shape <|-- Circle
  Shape <|-- Quadrilateral
  Shape <|-- WeirdShape
  
  Quadrilateral <|-- Rectangle
  Quadrilateral <|-- Parallelogram
  
  class Shape {
		<<Sealed>>
  }

  class Circle {
		<<Final>>
  }
  
  class Quadrilateral {
		<<Sealed>>
  }
  
  class WeirdShape {
		<<Final>>
  }
  
  class Rectangle {
  	<<Final>>
  }
  
  class Parallelogram {
  	<<Final>>
  }
```

å¦‚æœè¿™äº›ç±»æ¯”è¾ƒç®€çŸ­ï¼Œä¸”å¤§å¤šä»…å’Œæ•°æ®ç›¸å…³ï¼Œé‚£ä¹ˆå¯ä»¥å°†å®ƒä»¬å£°æ˜åœ¨**åŒä¸€ä¸ªæºæ–‡ä»¶ä¸­ï¼Œ`permits` å…³é”®å­—ä¹Ÿå¯ä»¥å¿½ç•¥**ï¼š

```java
public sealed class Shape {
  public final class Circle extends Shape {}

  public sealed class Quadrilateral extends Shape {
    public final class Rectangle extends Quadrilateral {}
    public final class Parallelogram extends Quadrilateral {}
  }

  public non-sealed class WeirdShape extends Shape {}
}
```

è®°å½•ç±»ä¹Ÿå¯ä»¥ä½œä¸ºå°é—­ç±»çš„å­ç±»ï¼Œå› ä¸ºå®ƒä»¬æ˜¯éšå¼ final çš„ã€‚

**è¢«å…è®¸ç»§æ‰¿çš„ç±»å¿…é¡»å’Œçˆ¶ç±»ï¼ˆå°é—­ç±»ï¼‰åœ¨åŒä¸€ä¸ªåŒ…é‡Œ**ï¼Œå¦‚æœæ˜¯ä½¿ç”¨ java æ¨¡å—ï¼Œé‚£å®ƒä»¬å¿…é¡»åœ¨åŒä¸€æ¨¡å—ä¸­ã€‚

### âš ï¸ æç¤ºï¼šè€ƒè™‘ä½¿ç”¨å°é—­ç±»è€Œéæšä¸¾ {#tip-consider-sealed-classes-vs-enums}

åœ¨*å°é—­ç±»*å‡ºç°å‰ï¼Œåªèƒ½ç”¨*æšä¸¾ç±»*å¯¹å›ºå®šå¯é€‰é¡¹å»ºæ¨¡ï¼Œæ¯”å¦‚ï¼š

```java
enum Expression {
  ADDITION,
  SUBTRACTION,
  MULTIPLICATION,
  DIVISION
}
```

ç„¶è€Œï¼Œæ‰€æœ‰çš„å˜é‡éƒ½è¦åœ¨åŒä¸€ä¸ªæºæ–‡ä»¶ä¸­ï¼Œä¸”*æšä¸¾ç±»*ä¸æ”¯æŒéœ€è¦å®ä¾‹çš„æƒ…å†µï¼ˆè€Œä¸æ˜¯å¸¸é‡ï¼‰ï¼Œä¾‹å¦‚è¡¨ç¤ºä¸€ä¸ªç±»å‹çš„å•ä¸ªæ¶ˆæ¯ã€‚

*å°é—­ç±»*æä¾›ä¸€ä¸ªæ¯”*æšä¸¾ç±»*æ›´å¥½çš„é€‰æ‹©ï¼Œä½¿å¾—ç”¨æ™®é€šç±»æ¥ä¸ºå›ºå®šå¯é€‰é¡¹å»ºæ¨¡æˆä¸ºå¯èƒ½ã€‚å½“ *switch æ¨¡å¼åŒ¹é…*åœ¨ç”Ÿäº§ç¯å¢ƒå¯ç”¨æ—¶å°±æ›´èƒ½å……åˆ†å‘æŒ¥å…¶ä½œç”¨ï¼Œ*å°é—­ç±»*èƒ½åƒæšä¸¾ä¸€æ ·åœ¨ `switch` è¡¨è¾¾å¼ä¸­ä½¿ç”¨ï¼Œç¼–è¯‘å™¨èƒ½è‡ªåŠ¨æ£€æŸ¥ä»£ç æ˜¯å¦æ¶µç›–äº†å…¨éƒ¨æƒ…å†µã€‚

æšä¸¾ç±»çš„å€¼å¯ä»¥ä½¿ç”¨ `values` æ–¹æ³•åˆ—ä¸¾å‡ºæ¥ã€‚å¯¹åº”åˆ°å°é—­ç±»å’Œå°é—­æ¥å£ï¼Œå¯ä»¥ä½¿ç”¨ `getPermittedSubclasses` æ–¹æ³•ä¾‹ä¸¾å‡ºæ‰€æœ‰è¢«å…è®¸ç»§æ‰¿çš„å­ç±»ã€‚


## è®°å½•ç±»

**å¼€å§‹æ”¯æŒç‰ˆæœ¬ï¼š** [`JDK 16`](https://openjdk.java.net/jeps/394) ( [`JDK 14`](https://openjdk.java.net/jeps/305)  [`JDK 15`](https://openjdk.java.net/jeps/375) ä¸ºé¢„è§ˆç‰¹æ€§)

è®°å½•ç±»ç»™ Java è¯­è¨€å¸¦æ¥äº†ä¸€ç§ã€Œæ–°çš„ã€ç±»å‹å£°æ˜ï¼Œé€šè¿‡ç®€çŸ­çš„è¯­æ³•æ¥åˆ›å»ºæ•°æ®ç±»ï¼ˆdata classesï¼‰ã€‚ç›¸è¾ƒäºä¼ ç»Ÿçš„ç§æœ‰æˆå‘˜å˜é‡ã€getter å’Œ setter æ–¹æ³•ä»¥åŠæ„é€ æ–¹æ³•æ¥æ„å»ºï¼Œè®°å½•ç±»å¯ä»¥è®©æˆ‘ä»¬ä½¿ç”¨ä¸€ç§**ç®€çŸ­çš„è¯­æ³•**æ¥å®šä¹‰ï¼š

```java
public record Point(int x, int y) { }
```

ä¸Šé¢çš„è®°å½•ç±»å¾ˆåƒæ™®é€šçš„ç±»ï¼Œå…¶æœ‰ä»¥ä¸‹å®šä¹‰ï¼š

- ä¸¤ä¸ª `private final` çš„æˆå‘˜å˜é‡ï¼š`int x` å’Œ `int y`
- ä¸€ä¸ªä»¥ `x` å’Œ `y` ä½œä¸ºå‚æ•°çš„æ„é€ æ–¹æ³•
- æˆå‘˜å˜é‡çš„ getter æ–¹æ³•ï¼š`x()` å’Œ `y()` 
- æ¶‰åŠ `x` å’Œ `y` å˜é‡çš„ `hashCode`ã€`equals` å’Œ `toString` æ–¹æ³•

å®ƒä»¬ä½¿ç”¨èµ·æ¥ä¹Ÿå¾ˆåƒä¸€èˆ¬çš„ç±»ï¼š

```java
var point = new Point(1, 2);
point.x(); // è¿”å› 1
point.y(); // è¿”å› 2
```

è®°å½•ç±»æ—¨äºä½œä¸º**æµ…å±‚ä¸å¯å˜æ•°æ®**ï¼ˆshallowly immutable dataï¼‰çš„**é€æ˜è½½ä½“**ï¼ˆtransparent carriersï¼‰ã€‚ä¸ºæ”¯æ’‘è¿™ç§è®¾è®¡ï¼Œéšä¹‹è€Œæ¥çš„æ˜¯ä¸€ç³»åˆ—**é™åˆ¶**ã€‚

è®°å½•ç±»ä¸ä»…ä»…æˆå‘˜å˜é‡é»˜è®¤æ˜¯ `final` çš„ï¼Œç”šè‡³**ä¸å…è®¸æœ‰é final çš„æˆå‘˜å˜é‡**ã€‚

**è®°å½•ç±»å¤´éƒ¨å¿…é¡»å®šä¹‰å‡ºæ‰€æœ‰å¯èƒ½çš„çŠ¶æ€**ã€‚å…¶ä¸»ä½“ä¸èƒ½å®šä¹‰é¢å¤–çš„æˆå‘˜å˜é‡ã€‚å†è€…ï¼Œè™½ç„¶å¯ä»¥å®šä¹‰é¢å¤–çš„æ„é€ æ–¹æ³•æ¥æä¾›ä¸€äº›æˆå‘˜å˜é‡çš„é»˜è®¤å€¼ï¼Œä½†æ— æ³•éšè—å«æœ‰æ‰€æœ‰æˆå‘˜å˜é‡çš„*æ ‡å‡†æ„é€ æ–¹æ³•*ï¼ˆ*canonical constructor*ï¼‰[^4]ã€‚

æœ€åï¼Œè®°å½•ç±»**ä¸èƒ½ç»§æ‰¿å…¶å®ƒç±»**ï¼Œ**ä¸èƒ½å£°æ˜ native æ–¹æ³•**ï¼Œæ˜¯**éšå¼ final çš„**ï¼Œä¹Ÿ**ä¸èƒ½æ˜¯æŠ½è±¡çš„**ã€‚

å› ä¸ºå®ƒçš„æˆå‘˜å˜é‡ä¸å¯å˜ï¼Œç»™å…¶*å¡«å……æ•°æ®*ä¹Ÿåªèƒ½é€šè¿‡æ„é€ æ–¹æ³•ã€‚

é»˜è®¤ä¸€ä¸ªè®°å½•ç±»ä»…æœ‰ä¸€ä¸ªéšå¼çš„*æ ‡å‡†æ„é€ æ–¹æ³•*ã€‚å¦‚æœæ•°æ®éœ€è¦æ ¡éªŒæˆ–æ ‡å‡†åŒ–ï¼ˆnormalizedï¼‰ï¼Œ*æ ‡å‡†æ„é€ æ–¹æ³•*ä¹Ÿèƒ½è¢«æ˜¾å¼å£°æ˜ï¼š

```java
public record Point(int x, int y) {
  public Point {
    if (x < 0) {
      throw new IllegalArgumentException("x can't be negative");
    }
    if (y < 0) {
      y = 0;
    }
  }
}
```

ç¼–è¯‘å™¨è‡ªåŠ¨æ·»åŠ çš„éšå¼*æ ‡å‡†æ„é€ æ–¹æ³•*å’Œè®°å½•ç±»æœ¬èº«å…·æœ‰ç›¸åŒçš„å¯è§æ€§ã€‚å¦‚æœæ˜¯æ˜¾å¼å£°æ˜çš„ï¼Œå®ƒçš„è®¿é—®ä¿®é¥°ç¬¦å¿…é¡»è‡³å°‘å’Œè®°å½•ç±»çš„è®¿é—®ä¿®é¥°ç¬¦å…·æœ‰ä¸€æ ·æƒé™ã€‚

è®°å½•ç±»ä¹Ÿå¯ä»¥è‡ªå®šä¹‰é¢å¤–çš„æ„é€ æ–¹æ³•ï¼Œä½†æ˜¯å¿…é¡»å§”æ´¾ç»™å…¶å®ƒçš„æ„é€ æ–¹æ³•ã€‚å› ä¸ºæœ€å*æ ‡å‡†æ„é€ æ–¹æ³•*å§‹ç»ˆä¼šè¢«è°ƒç”¨ã€‚é¢å¤–çš„æ„é€ æ–¹æ³•å¯¹äºè®¾ç½®é»˜è®¤å€¼å¾ˆæœ‰ç”¨ã€‚

```java
public record Point(int x, int y) {
  public Point(int x) {
    this(x, 0);
  }
}
```

ä»è®°å½•ç±»*è·å–æ•°æ®*æ˜¯é€šè¿‡å®ƒçš„è®¿é—®å™¨æ–¹æ³•ã€‚å¯¹äºæ¯ä¸ªæˆå‘˜å˜é‡ï¼Œä¾‹å¦‚ xï¼Œè®°å½•ç±»éƒ½ä¼šç”Ÿæˆå¯¹åº”çš„å…¬å…± getter æ–¹æ³•ï¼Œåƒ `x()` è¿™ç§æ ¼å¼ã€‚

è¿™äº› getter æ–¹æ³•ä¹Ÿå¯ä»¥æ˜¾å¼å£°æ˜ï¼š

```java
public record Point(int x, int y) {
  @Override
  public int x() {
    return x;
  }
}
```

æ³¨æ„ä¸Šé¢çš„ä¾‹å­ï¼Œ `Override` æ³¨è§£èƒ½è¢«ç”¨äºç¡®ä¿æ˜¾å¼å®šä¹‰çš„æ–¹æ³•æ˜¯ä¸€ä¸ªè®¿é—®å™¨æ–¹æ³•ï¼Œè€Œä¸æ˜¯æ„å¤–åœ°æ·»åŠ æˆå…¶å®ƒæ™®é€šæ–¹æ³•ã€‚

é™¤äº† getter æ–¹æ³•ï¼Œ`hashCode`ã€`equals` ä»¥åŠ `toString` æ–¹æ³•éƒ½æœ‰é»˜è®¤æä¾›ï¼Œä¸”æ¶‰åŠæ‰€æœ‰æˆå‘˜å˜é‡ï¼›å½“ç„¶è¿™äº›æ–¹æ³•ä¹Ÿå¯ä»¥æ˜¾å¼å£°æ˜ã€‚

æœ€åï¼Œè®°å½•ç±»ä¹Ÿå…è®¸æœ‰é™æ€æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•ï¼Œç”¨äºæ–¹ä¾¿åœ°å¾—åˆ°è¡ç”Ÿä¿¡æ¯æˆ–æ˜¯ä½œä¸ºå·¥å‚æ–¹æ³•ï¼š

```java
public record Point(int x, int y) {
  static Point zero() {
    return new Point(0, 0);
  }
  
  boolean isZero() {
    return x == 0 && y == 0;
  }
}
```

å°ç»“ä¸€ä¸‹ï¼š**è®°å½•ç±»ä¸“æ³¨äºæ‰¿è½½æ•°æ®**ï¼Œä¸æä¾›å¤ªå¤šå®šåˆ¶åŒ–é€‰é¡¹ã€‚

å¾—ç›Šäºè¿™æ ·çš„ç‰¹æ®Šè®¾è®¡ï¼Œ**è®°å½•ç±»çš„åºåˆ—åŒ–ä¹Ÿååˆ†å®¹æ˜“**ä¸”å®‰å…¨ï¼Œç›¸è¾ƒäº[å…¶å®ƒçš„æ™®é€šç±»](https://cr.openjdk.java.net/~briangoetz/amber/serialization.html)æ¥è¯´ã€‚å°±åƒ JEP ä¸­æåŠçš„ï¼š

> è®°å½•ç±»çš„å®ä¾‹èƒ½è¢«åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚ç„¶è€Œä¸èƒ½é€šè¿‡æä¾› writeObjectï¼ŒreadObjectï¼ŒreadObjectNoDataï¼ŒwriteExternal æˆ– readExternal æ–¹æ³•æ¥è‡ªå®šä¹‰å…¶å¤„ç†æµç¨‹ã€‚è®°å½•ç±»çš„ç»„ä»¶ï¼ˆæˆå‘˜å˜é‡ï¼‰è´Ÿè´£åºåˆ—åŒ–ï¼Œè€Œè®°å½•ç±»çš„æ ‡å‡†æ„é€ æ–¹æ³•æŒç®¡ååºåˆ—åŒ–ã€‚

ç”±äºåºåˆ—åŒ–æ­£å¥½åŸºäºæˆå‘˜å˜é‡çš„çŠ¶æ€ï¼Œååºåˆ—åŒ–åˆæ€»ä¼šè°ƒç”¨æ ‡å‡†æ„é€ æ–¹æ³•ï¼Œæ‰€ä»¥ä¸å¯èƒ½åˆ›å»ºä¸€ä¸ªæ— æ•ˆçŠ¶æ€çš„è®°å½•ç±»ã€‚

ä»ç”¨æˆ·ï¼ˆå¼€å‘è€…ï¼‰çš„è§’åº¦æ¥çœ‹ï¼Œå¼€å¯å’Œä½¿ç”¨åºåˆ—åŒ–å’Œä»¥å¾€ä¸€æ ·ï¼š

```java
public record Point(int x, int y) implements Serializable { }

public static void recordSerializationExample() throws Exception {
  Point point = new Point(1, 2);

  // åºåˆ—åŒ–
  ObjectOutputStream oos =
    new ObjectOutputStream(new FileOutputStream("tmp"));
  oos.writeObject(point);

  // ååºåˆ—åŒ–
  ObjectInputStream ois =
    new ObjectInputStream(new FileInputStream("tmp"));
  Point deserialized = (Point) ois.readObject();
}
```

æ³¨æ„è¿™é‡Œä¸å†éœ€è¦å®šä¹‰ `serialVersionUID` äº†ï¼Œå› ä¸ºè®°å½•ç±»æŠ›å¼ƒäº†å¯¹ `serialVersionUID` æ¯”å¯¹çš„è¦æ±‚ã€‚

å‚è€ƒæ¥æºï¼š

- [Inside Java Podcast Episode 4: â€œRecord Classesâ€ with Gavin Bierman](https://inside.java/2020/10/05/podcast-004/)
- [Inside Java Podcast Episode 14: â€œRecords Serializationâ€ with Julia Boes and Chris Hegarty](https://inside.java/2021/03/08/podcast-014/)
- [Towards Better Serialization - Brian Goetz, June 2019](https://cr.openjdk.java.net/~briangoetz/amber/serialization.html)
- [Record Serialization](https://docs.oracle.com/en/java/javase/16/docs/specs/records-serialization.html)

### âš ï¸ æç¤ºï¼šä½¿ç”¨æœ¬åœ°è®°å½•ç±»æ¥æ„å»ºä¸­é—´è½¬åŒ–å˜é‡ {#tip-use-local-records-to-model-intermediate-transformations}

å¤æ‚çš„æ•°æ®è½¬æ¢éœ€è¦æˆ‘ä»¬æ„å»ºä¸­é—´å˜é‡ã€‚åœ¨ Java 16 ä¹‹å‰ï¼Œå…¸å‹æ–¹æ¡ˆæ˜¯ä¾èµ–äº Pair æˆ–ä¸‰æ–¹åº“é‡Œç›¸ä¼¼çš„ holder ç±»ï¼Œå†æˆ–è€…æ˜¯è‡ªå·±å®šä¹‰ï¼ˆå¯èƒ½æ˜¯é™æ€å†…éƒ¨ï¼‰ç±»æ¥æ‰¿è½½æ•°æ®ã€‚

è¿™æ ·åšçš„é—®é¢˜æ˜¯ï¼Œå‰è€…é€šå¸¸è¢«è¯å®ä¸å¤Ÿçµæ´»ï¼Œåè€…åˆåœ¨ä»…ç”¨äºå•ä¸ªæ–¹æ³•çš„ä¸Šä¸‹æ–‡ä¸­å¼•å…¥äº†å…¶å®ƒç±»ï¼Œæ±¡æŸ“äº†å‘½åç©ºé—´ã€‚è™½ç„¶ä¹Ÿå¯ä»¥åœ¨æ–¹æ³•ä½“ä¸­å®šä¹‰ç±»ï¼Œä½†ä¹Ÿå› ä¸ºå…¶å•°å—¦çš„è¯­æ³•å¾ˆå°‘è¿™ä¹ˆç”¨ã€‚

Java 16 æ”¹è¿›äº†è¿™ç‚¹ï¼Œç°åœ¨ä¹Ÿå¯ä»¥**åœ¨æ–¹æ³•ä½“ä¸­å®šä¹‰æœ¬åœ°è®°å½•ç±»**ï¼š

```java
public List<Product> findProductsWithMostSaving(List<Product> products) {
  record ProductWithSaving(Product product, double savingInEur) {}

  products.stream()
    .map(p -> new ProductWithSaving(p, p.basePriceInEur * p.discountPercentage))
    .sorted((p1, p2) -> Double.compare(p2.savingInEur, p1.savingInEur))
    .map(ProductWithSaving::product)
    .limit(5)
    .collect(Collectors.toList());
}
```

è®°å½•ç±»ç´§å‡‘çš„è¯­æ³•æ­£å¥½å¥‘åˆ Steam API ç´§å‡‘çš„è¯­æ³•ã€‚

é™¤äº†è®°å½•ç±»å¤–ï¼Œè¿™ä¸ªæ”¹è¿›ä¹Ÿ**é€‚ç”¨äºæœ¬åœ°æšä¸¾ç”šè‡³æ¥å£**ã€‚

### âš ï¸ æç¤ºï¼šæ£€æŸ¥ä½ ç”¨çš„ç±»åº“ {#tip-check-your-libraries}

**è®°å½•ç±»æ²¡æœ‰éµå¾ª [JavaBeans](https://www.oracle.com/java/technologies/javase/javabeans-spec.html) çš„çº¦å®š**ï¼š

- æ²¡æœ‰é»˜è®¤çš„æ„é€ æ–¹æ³•ï¼›
- æ²¡æœ‰ setter æ–¹æ³•ï¼›
- è®¿é—®å™¨æ–¹æ³•ä¸ä¾ç…§ `getX()` æ ¼å¼ï¼›

ç”±äºä»¥ä¸ŠåŸå› ï¼Œ**ä¸€äº›ä¾å¾ª JavaBeans çº¦å®šçš„å·¥å…·ç±»å’Œè®°å½•ç±»å¯èƒ½ä¸èƒ½æ­£å¸¸ä½¿ç”¨**ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œ**è®°å½•ç±»ä¸èƒ½ç”¨ä½œ JPAï¼ˆæ¯”å¦‚ Hibernate ï¼‰çš„å®ä½“**ã€‚æœ‰ä¸€äº›[å…³äº JPA éµå¾ªè®°å½•ç±»è§„èŒƒçš„è®¨è®º](https://www.eclipse.org/lists/jpa-dev/msg00056.html)ï¼Œä½†è¿„ä»Šä¸ºæ­¢æˆ‘æ²¡æ‰¾åˆ°ç›¸å…³å¼€å‘è¿›åº¦çš„æŠ¥é“ã€‚ç„¶è€Œå€¼å¾—ä¸€æçš„æ˜¯ï¼Œæœ‰æ–‡ç« æŒ‡å‡º[å°†è®°å½•ç±»èƒ½åº”ç”¨åˆ°é¡¹ç›®ä¸­](https://thorben-janssen.com/java-records-hibernate-jpa/)ä¸”æ²¡æœ‰é—®é¢˜ã€‚

å¤§å¤šæ•°æˆ‘[è¯•è¿‡çš„å·¥å…·ç±»](https://advancedweb.hu/working-with-structured-data-in-java/)ï¼ˆåŒ…æ‹¬ [Jackson](https://github.com/FasterXML/jackson)ï¼Œ[Apache Commons Lang](https://commons.apache.org/proper/commons-lang/)ï¼Œ[JSON-P](https://javaee.github.io/jsonp/)ï¼Œ[Guava](https://github.com/google/guava) ï¼‰éƒ½**æ”¯æŒè®°å½•ç±»ï¼Œä½†ç”±äºå®ƒååˆ†æ–°è¿˜å­˜åœ¨äº›å°é—®é¢˜**ã€‚æ¯”å¦‚ï¼Œæµè¡Œçš„ JSON åº“ Jackson [è¾ƒæ—©å°±æ”¯æŒè®°å½•ç±»](https://github.com/FasterXML/jackson-future-ideas/issues/46)ã€‚å®ƒçš„å¤§å¤šæ•°ç‰¹æ€§ï¼ŒåŒ…æ‹¬å¯¹è®°å½•ç±»å’Œ JavaBeans çš„åºåˆ—åŒ–ã€ååºåˆ—åŒ–éƒ½æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†[æ“æ§å¯¹è±¡çš„ç‰¹æ€§è¿˜æ²¡é€‚é…](https://github.com/FasterXML/jackson-databind/issues/3079)ã€‚

æˆ‘é‡åˆ°çš„å¦ä¸€ä¸ªä¾‹å­æ˜¯ [Springï¼Œä¹Ÿåœ¨è®¸å¤šæƒ…å†µä¸‹å¯¹è®°å½•ç±»æä¾›å¼€ç®±å³ç”¨çš„æ”¯æŒ](https://dzone.com/articles/jdk-14-records-for-spring-devs)ã€‚åŒ…æ‹¬äº†åºåˆ—åŒ–ç”šè‡³ä¾èµ–æ³¨å…¥ï¼Œä½†è®¸å¤š Spring åº”ç”¨ç¨‹åºä½¿ç”¨çš„ [ModelMapper](https://github.com/modelmapper/modelmapper) åº“ [ä¸æ”¯æŒå°† JavaBeans æ˜ å°„åˆ°è®°å½•ç±»](https://github.com/modelmapper/modelmapper/issues/546)ã€‚

æˆ‘çš„å»ºè®®æ˜¯ï¼Œ**åœ¨ä½¿ç”¨è®°å½•ç±»å‰å…ˆå‡çº§å¹¶æ£€æŸ¥ä½¿ç”¨çš„å·¥å…·åº“**ï¼Œé¿å…æ„å¤–ä¹‹å–œï¼Œä½†å¤§ä½“ä¸Šæ¥è¯´ï¼Œå¯ä»¥è®¤ä¸ºæµè¡Œçš„å·¥å…·åº“å·²ç»æ¶µç›–äº†å¤§éƒ¨åˆ†ç‰¹æ€§ã€‚

å‚çœ‹æˆ‘åœ¨ [Github ä¸Šå…³äºè®°å½•ç±»çš„å·¥å…·åº“é›†æˆè¯•éªŒ](https://github.com/dodie/java-tutorials/tree/master/working-with-structured-data)ã€‚


## instanceof æ¨¡å¼åŒ¹é…

**å¼€å§‹æ”¯æŒç‰ˆæœ¬ï¼š** [`JDK 16`](https://openjdk.java.net/jeps/394) ( [`JDK 14`](https://openjdk.java.net/jeps/305)  [`JDK 15`](https://openjdk.java.net/jeps/375) ä¸ºé¢„è§ˆç‰¹æ€§)

å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ`instanceof` éƒ½ä¼šè·Ÿä¸€ä¸ªæ˜¾å¼çš„ç±»å‹è½¬æ¢ï¼š

```java
if (obj instanceof String) {
    String s = (String) obj;
    // ä½¿ç”¨å˜é‡ s
}
```

è‡³å°‘ä»¥å‰æ˜¯è¿™æ ·ï¼Œå¥½åœ¨ Java 16 æ‰©å±•äº† `instanceof` å…³é”®å­—ï¼Œä½¿å…¶åœ¨ä½¿ç”¨æ—¶ä¸å†é‚£ä¹ˆå•°å—¦ï¼š

```java
if (obj instanceof String s) {
    // ä½¿ç”¨å˜é‡ s
}
```

è¿™ç§æ¨¡å¼åŒ¹é…å…¶å®æ˜¯ä¸€ç§*æ£€æŸ¥*ï¼ˆobj instance ofï¼‰å’Œ*æ¨¡å¼å˜é‡*ï¼ˆsï¼‰çš„ç»„åˆã€‚

è¿™ç§*æ£€æŸ¥*å’Œ**æ—§çš„ instanceof æ“ä½œç¬¦å‡ ä¹ä¸€æ ·**ï¼Œé™¤äº†è‹¥ä¸ä¿è¯å®ƒèƒ½é€šè¿‡çš„è¯ï¼Œä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ã€‚

```java
// è€çš„ instanceof æ“ä½œç¬¦ï¼Œæ²¡æœ‰æ¨¡å¼å˜é‡ï¼š
// ç¼–è¯‘æ—¶è¿™ä¸ªæ¡ä»¶ä¸€ç›´æ˜¯ true
Integer i = 1;
if (i instanceof Object) { ... } // æ²¡é—®é¢˜

// æ–°çš„ instanceof æ“ä½œç¬¦ï¼Œæœ‰æ¨¡å¼å˜é‡ï¼š
// åœ¨è¿™ç§æƒ…å½¢ä¼šäº§ç”Ÿç¼–è¯‘é”™è¯¯
if (i instanceof Object o) { ... } // æŠ¥é”™
```

æ³¨æ„ï¼Œç›¸åå³ä½¿ç”¨çš„æ˜¯æ—§çš„ instanceof æ“ä½œç¬¦ï¼Œå‡ºç°äº†ç¼–è¯‘é”™è¯¯ï¼Œé‚£ä¹ˆæ¨¡å¼åŒ¹é…ä¹Ÿæ€»ä¼šå¤±è´¥ã€‚

è€Œä¸”ä»…åœ¨æ£€æŸ¥é€šè¿‡æ—¶ï¼Œ*æ¨¡å¼å˜é‡*æ‰ä¼šä»ç›®æ ‡å˜é‡ä¸­æå–å‡ºæ¥ã€‚**å®ƒå‡ ä¹å’Œå¸¸è§„çš„é final å˜é‡ä¸€æ ·**ï¼š

- å€¼èƒ½è¢«ä¿®æ”¹
- å¯ä»¥è·Ÿåœ¨æˆå‘˜å˜é‡å£°æ˜çš„åé¢
- å¦‚æœå’Œæœ¬åœ°å˜é‡é‡åï¼Œå°†ä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯

ç„¶è€Œï¼Œæ¨¡å¼å˜é‡æœ‰ç€ç‰¹æ®Šçš„ä½œç”¨åŸŸè§„åˆ™ï¼šè¯¥ä½œç”¨åŸŸæ˜¯æ˜ç¡®åŒ¹é…çš„ï¼Œå¹¶ç”±æµç¨‹æ§åˆ¶çš„ä½œç”¨åŸŸè§£æå†³å®šã€‚

ä»ä¸Šé¢ä¾‹å­é‡Œå¯ä»¥çœ‹å‡ºæœ€ç®€å•çš„æƒ…å½¢ï¼šå¦‚æœæ£€æŸ¥é€šè¿‡ï¼Œå˜é‡ s èƒ½åœ¨ if è¯­å—ä¸­ä½¿ç”¨ã€‚

ä½†ã€Œæ˜ç¡®åŒ¹é…ã€çš„è§„åˆ™ä¹Ÿèƒ½åº”ç”¨åˆ°æ›´å¤æ‚çš„æƒ…å½¢ï¼š

```java
if (obj instanceof String s && s.length() > 5) {
  // ä½¿ç”¨å˜é‡ s
}
```

å˜é‡ s èƒ½è¢«ç”¨äºåˆ¤æ–­æ¡ä»¶çš„ç¬¬äºŒéƒ¨åˆ†æ˜¯å› ä¸ºï¼Œä»…åœ¨ç¬¬ä¸€éƒ¨åˆ†çš„ instanceof æ“ä½œç¬¦åŒ¹é…æˆåŠŸæ—¶ï¼Œå®ƒæ‰ä¼šè¢«èµ‹å€¼ã€‚

å†æ¥ä¸ªæ›´ç»†èŠ‚çš„ä¾‹å­ï¼Œæå‰è¿”å›å€¼å’Œå¼‚å¸¸ä¹Ÿèƒ½ç¡®ä¿åŒ¹é…ï¼š

```java
private static int getLength(Object obj) {
  if (!(obj instanceof String s)) {
    throw new IllegalArgumentException();
  }

  // å˜é‡ s åœ¨ä½œç”¨åŸŸä¸­ - å¦‚æœ instanceof æ²¡èƒ½åŒ¹é…æˆåŠŸ
  //      åˆ™ä¸ä¼šæ‰§è¡Œåˆ°è¿™ä¸ªå£°æ˜
  return s.length();
}
```

æµç¨‹æ§åˆ¶çš„ä½œç”¨åŸŸè§£æå’Œç°æœ‰çš„æµç¨‹è§£æå¾ˆç›¸ä¼¼ï¼Œæ¯”å¦‚å¯¹[æ˜ç¡®èµ‹å€¼](https://docs.oracle.com/javase/specs/jls/se15/html/jls-16.html)çš„æ£€æŸ¥ï¼š

```java
private static int getDoubleLength(String s) {
  int a; // å˜é‡ a å£°æ˜äº†ä½†æœªèµ‹å€¼
  if (s == null) {
    return 0; // æå‰è¿”å›
  } else {
    a = s.length(); // èµ‹å€¼å˜é‡ a
  }

  // å˜é‡ a å·²ç»æ˜¯æ˜ç¡®èµ‹å€¼çš„
  // æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒ
  a = a * 2;
  return a;
}
```

æˆ‘ååˆ†å–œæ¬¢è¿™ä¸ªç‰¹æ€§ï¼Œå› ä¸ºå®ƒå¯¹å‡å°‘ Java ç¨‹åºä¸­æ˜¾å¼ç±»å‹è½¬æ¢é€ æˆéå¿…è¦ä»£ç è†¨èƒ€å¾ˆä¼šæœ‰å¸®åŠ©ã€‚ç›¸è¾ƒäºå…¶å®ƒç°ä»£ç¼–ç¨‹è¯­è¨€ï¼Œä»æ˜¾å¾—æœ‰é‚£ä¹ˆä¸€ç‚¹ç‚¹å•°å—¦ã€‚

æ¯”å¦‚åœ¨ Kotlin ä¸­ä½ æ ¹æœ¬ä¸éœ€è¦å®šä¹‰æ¨¡å¼å˜é‡ï¼š

```kotlin
if (obj is String) {
    print(obj.length)
}
```

è‡³äº Java çš„æ¨¡å¼å˜é‡ï¼Œæ˜¯ç¡®ä¿å‘åå…¼å®¹æ€§çš„æ‰‹æ®µã€‚å› ä¸ºæ”¹å˜ obj instanceof String ä¸­ obj çš„ç±»å‹ä¹Ÿå°±æ„å‘³ç€ï¼Œåœ¨å…¶è¢«ç”¨ä½œé‡è½½æ–¹æ³•å‚æ•°çš„æ—¶å€™ï¼Œè°ƒç”¨å¯èƒ½ä¼šè¢«è§£ææˆè¿™ä¸ªæ–¹æ³•çš„ä¸åŒç‰ˆæœ¬ã€‚

### âš ï¸ æç¤ºï¼šæ•¬è¯·å…³æ³¨æ›´æ–°

æ¨¡å¼åŒ¹é…åœ¨å½“ä¸‹çœ‹æ¥å¯èƒ½æ²¡ä»€ä¹ˆå¤§ä¸äº†çš„ï¼Œä½†å¾ˆå¿«ä¼šæœ‰æ›´å¤šæœ‰æ„æ€çš„ç‰¹æ€§å‘å¸ƒã€‚

[JEP 405](https://openjdk.java.net/jeps/405) æè®®æ–°å¢ä¸€ä¸ªè§£æ„çš„ç‰¹æ€§ï¼Œæ¥æ”¯æŒå…¶èƒ½ç”¨äºè®°å½•ç±»æˆ–æ•°ç»„ï¼š

```java
if (o instanceof Point(int x, int y)) {
  System.out.println(x + y);
}

if (o instanceof String[] { String s1, String s2, ... }){
  System.out.println("The first two elements of this array are: " + s1 + ", " + s2);
}
```

æ¥ä¸‹æ¥ï¼Œ[JEP 406](https://openjdk.java.net/jeps/406) å‡†å¤‡å°†æ¨¡å¼åŒ¹é…å¸¦åˆ° switch è¡¨è¾¾å¼å’Œè¯­å¥ä¸­ï¼š

```java
return switch (o) {
  case Integer i -> String.format("int %d", i);
  case Long l    -> String.format("long %d", l);
  case Double d  -> String.format("double %f", d);
  case String s  -> String.format("String %s", s);
  default        -> o.toString();
};
```

ç°åœ¨è¿™ä¸¤ä¸ªæè®®éƒ½è¿˜åœ¨å¤‡é€‰çŠ¶æ€ï¼Œæœªæ˜ç¡®å…¶å…·ä½“æ­è½½çš„ç‰ˆæœ¬å·ï¼Œå¸Œæœ›èƒ½å°½æ—©çœ‹åˆ°å…¶é¢„è§ˆç‰ˆæœ¬å‘å¸ƒã€‚


## æ–‡æœ¬å—

**å¼€å§‹æ”¯æŒç‰ˆæœ¬ï¼š** [`JDK 15`](https://openjdk.java.net/jeps/378) ( [`JDK 13`](https://openjdk.java.net/jeps/355)  [`JDK 14`](https://openjdk.java.net/jeps/368) ä¸ºé¢„è§ˆç‰¹æ€§)

ç›¸è¾ƒäºå…¶å®ƒç°ä»£ç¼–ç¨‹è¯­è¨€ï¼Œåœ¨ Java ä¸­ç¼–å†™å¤šè¡Œå­—ç¬¦ä¸²æ˜¯è‡­åæ˜­è‘—çš„éº»çƒ¦ï¼š

```java
String html = "";
html += "<html>\n";
html += "  <body>\n";
html += "    <p>Hello, world</p>\n";
html += "  </body>\n";
html += "</html>\n";

System.out.println(html);
```

ä¸ºæ”¹è¿›è¿™ç§æƒ…å†µï¼Œæ›´åŠ åˆ©å¥½ç¨‹åºå‘˜ï¼ŒJava 15 å¼•å…¥äº†å¤šè¡Œå­—ç¬¦ä¸²å­—é¢é‡ï¼Œå«åšæ–‡æœ¬å—ï¼š

```java
String html = """
          <html>
            <body>
              <p>Hello, world</p>
            </body>
          </html>
          """;

System.out.println(html);
```

å®ƒä»¬å’Œä¹‹å‰æ—§çš„å­—ç¬¦ä¸²å­—é¢é‡ç›¸ä¼¼ï¼Œä½†å®ƒä»¬**æ¢è¡Œå’Œå¼•å·éƒ½ä¸éœ€è¦è½¬ä¹‰**ã€‚

æ–‡æœ¬å—å¼€å§‹äº `"""`ï¼Œåé¢ç´§è·Ÿæ¢è¡Œï¼Œæœ€åä¹Ÿä»¥ `"""` ç»“å°¾ã€‚ç»“å°¾æ ‡è®°å¯ä»¥æ”¾åœ¨æœ€åä¸€è¡Œï¼Œä¹Ÿå¯ä»¥åƒä¸Šé¢çš„ä¾‹å­æ–°èµ·ä¸€è¡Œã€‚

å®ƒä»¬å¯ä»¥ç”¨åœ¨ä»»ä½•ä¹‹å‰æ—§çš„å­—ç¬¦ä¸²å­—é¢é‡èƒ½ä½¿ç”¨çš„åœ°æ–¹ï¼Œéƒ½åŒæ ·äº§ç”Ÿ String å¯¹è±¡ã€‚

æºä»£ç ä¸­çš„æ¯ä¸ªæ¢è¡Œçš„åœ°æ–¹éƒ½ä¼šäº§ç”Ÿä¸€ä¸ª `\n` å­—ç¬¦ã€‚

```java
String twoLines = """
          Hello
          World
          """;
```

è¿™æ ·å¯ä»¥é¿å…æ¯è¡Œä»¥ `\` å­—ç¬¦ç»“å°¾ï¼Œå¯¹äºé‚£äº›å¤ªé•¿ä»¥è‡³äºä¸å¾—ä¸æ¢è¡Œçš„å­—ç¬¦ä¸²æ¥è¯´ï¼Œä¿æŒå…¶ä»£ç å¯è¯»æ€§ååˆ†æœ‰å¸®åŠ©ã€‚

```java
String singleLine = """
          Hello \
          World
          """;
```

æ–‡æœ¬æ®µå¯ä»¥å’Œç›¸é‚»çš„ Java ä»£ç å¯¹é½ï¼Œå› ä¸º**æ„å¤–çš„ç¼©è¿›ä¼šè¢«è‡ªåŠ¨ç§»é™¤**ã€‚ç¼–è¯‘å™¨ä¼šæ£€æŸ¥æ¯è¡Œç”¨äºç¼©è¿›çš„ç©ºæ ¼ï¼Œæ‰¾åˆ°ç¼©è¿›æœ€å°‘çš„è¡Œï¼Œç„¶åå°†æ¯è¡Œéƒ½è½¬åŒ–ä¸ºè¿™ä¸ªç›¸åŒçš„æœ€å°‘ç¼©è¿›ã€‚

è¿™å°±æ„å‘³ç€å¦‚æœç»“å°¾çš„ `"""` æ˜¯åœ¨ä¸€ä¸ªå•ç‹¬çš„è¡Œï¼Œè½¬å˜ç»“å°¾æ ‡è®°åˆ°å·¦è¾¹ä¼šå¯¼è‡´ç¼©è¿›å¢åŠ ã€‚

```java
String noIndentation = """
          First line
          Second line
          """;

String indentedByToSpaces = """
          First line 
          Second line
        """;
```

å¼€å¤´çš„ `"""` ä¸ä¼šå½±å“ç¼©è¿›ç§»é™¤ï¼Œæ‰€ä»¥æ–‡æœ¬å—æ²¡æœ‰å¿…è¦å’Œå…¶å¯¹é½ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢çš„ä¾‹å­å°†äº§ç”Ÿç›¸åŒçš„ç¼©è¿›ï¼š

```java
String indentedByToSpaces = """
         First line 
         Second line
       """;

String indentedByToSpaces = """
                              First line 
                              Second line
                            """;
```

`String` ç±»é€šç”¨ä¹Ÿå¯ä»¥é€šè¿‡ç¼–ç¨‹å¼çš„æ–¹æ³•æ¥å¤„ç†ç¼©è¿›ã€‚`indent` æ–¹æ³•æ¥æ”¶ä¸€ä¸ªæ•´æ•°ä½œä¸ºå…¥å‚ï¼Œç›¸åº”çš„è¿”å›ä¸€ä¸ªæ–°çš„ï¼Œç‰¹å®šç¼©è¿›çº§åˆ«çš„å­—ç¬¦ä¸²ï¼›ä¸ä¹‹å¯¹åº”çš„ï¼Œ`stripIndent` æ–¹æ³•è¿”å›ä¸€ä¸ªç§»é™¤æºå†…å®¹æ‰€æœ‰ç¼©è¿›çš„å­—ç¬¦ä¸²ã€‚

æ–‡æœ¬å—ä¸æ”¯æŒæ’å€¼ï¼Œè¿™ä¸ªåŠŸèƒ½æˆ‘ååˆ†æœŸå¾…ã€‚JEP è¡¨ç¤ºåœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸­ä¼šè€ƒè™‘ï¼Œä½†åˆ°é‚£ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `String::formatted` æˆ– `String::format`ï¼š

```java
var greeting = """
    hello
    %s
    """.formatted("world");
```

å‚è€ƒæ¥æºï¼š

- [Programmerâ€™s Guide To Text Blocks](https://cr.openjdk.java.net/~jlaskey/Strings/TextBlocksGuide_v11.html)
- [Definitive Guide To Text Blocks In Java 13](https://nipafx.dev/java-13-text-blocks#)
- [Java Text Blocks - Bealdung](https://www.baeldung.com/java-text-blocks)

### âš ï¸ æç¤ºï¼šä¿ç•™ç»“å°¾ç©ºæ ¼ {#tip-preserve-trailing-spaces}

åœ¨æ–‡æœ¬å—çš„ç»“å°¾ç©ºæ ¼ä¼šè¢«å¿½ç•¥æ‰ã€‚è¿™é€šå¸¸ä¸æ˜¯é—®é¢˜ï¼Œé™¤éåœ¨ç‰¹å®šçš„åœºæ™¯ï¼Œæ¯”å¦‚åœ¨å•å…ƒæµ‹è¯•æ—¶ä¸€ä¸ªæ–¹æ³•çš„æ‰§è¡Œç»“æœéœ€è¦å’Œä¸€ä¸ªåŸºå‡†å€¼åšæ¯”è¾ƒã€‚

å¦‚æœæ˜¯éœ€è¦è€ƒè™‘è¿™äº›çš„åœºæ™¯æ—¶ï¼Œè¿™è¡Œç»“å°¾éœ€è¦æ·»åŠ  `\s` æˆ– `\t`ï¼Œè€Œä¸æ˜¯ç©ºæ ¼æˆ–è€…æ˜¯åˆ¶è¡¨ç¬¦ã€‚

### âš ï¸ æç¤ºï¼šæ­£ç¡®å¤„ç† Windows çš„æ¢è¡Œç¬¦ {#tip-produce-the-correct-newline-charactors-for-windows}

[æ¢è¡Œ](https://en.wikipedia.org/wiki/Newline)åœ¨ Unix å’Œ Windows ä¸‹æœ‰ç€ä¸åŒçš„æ§åˆ¶ç¬¦ã€‚å‰è€…ä½¿ç”¨å•ä¸€çš„æ¢è¡Œç¬¦ï¼ˆ`\n`ï¼‰ï¼Œè€Œåè€…å¤šä½¿ç”¨äº†å›è½¦ç¬¦ï¼ˆ`\r\n`ï¼‰ã€‚

ç„¶åä¸è®ºä½ æ˜¯ç”¨ä»€ä¹ˆæ“ä½œç³»ç»Ÿï¼Œæˆ–è€…åœ¨æºç ä¸­ä½¿ç”¨ä»€ä¹ˆæ¢è¡Œç¬¦ï¼Œæ–‡æœ¬å—éƒ½ä¼šä½¿ç”¨å•ä¸€çš„ `\n` æ¥æ¢è¡Œï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å…¼å®¹æ€§é—®é¢˜ã€‚

```java
Files.writeString(Paths.get("<PATH_TO_FILE>"), """
    first line
    second line
    """);
```

å¦‚æœä½¿ç”¨ä¸€ä¸ªä»…å…¼å®¹ Windows æ¢è¡Œç¬¦çš„è½¯ä»¶ï¼ˆå¦‚ Notepadï¼‰æ‰“å¼€è¿™æ ·çš„æ–‡ä»¶ï¼Œä¼šå•å•åªæ˜¾ç¤ºä¸€è¡Œã€‚å¦‚æœä½ æ—¨åœ¨å…¼å®¹ Windows ç³»ç»Ÿï¼Œè¯·ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„æ¢è¡Œç¬¦ï¼Œæ¯”æ–¹è¯´ä½¿ç”¨ `Stirng::replace` æ¥æ›¿æ¢æ¯ä¸€ä¸ª `"\n"` å­—ç¬¦ä¸º `"\r\n"`ã€‚

### âš ï¸ æç¤ºï¼šå…³æ³¨ç¼©è¿›çš„ä¸€è‡´æ€§ {#tip-pay-attention-to-consistent-indentation}

æ–‡æœ¬å—åœ¨ä»»æ„ç±»å‹çš„ç¼©è¿›ä¸‹éƒ½èƒ½èƒœä»»ï¼šåˆ¶è¡¨ç¬¦ã€ç©ºæ ¼æˆ–è€…ä¸¤è€…æ··ç”¨ã€‚ä½†æ¯è¡Œä½¿ç”¨ä¸€è‡´çš„ç¼©è¿›å¾ˆé‡è¦ï¼Œå¦åˆ™æ„å¤–çš„ç¼©è¿›ä¸ä¼šè¢«ç§»é™¤ã€‚

å¤§å¤šæ•°æ–‡æœ¬ç¼–è¾‘å™¨éƒ½æä¾›äº†è‡ªåŠ¨æ ¼å¼åŒ–ï¼Œä¸”åœ¨ä½ æ•²å‡»å›è½¦é”®æ—¶ä¼šè‡ªåŠ¨æ·»åŠ ç¼©è¿›ã€‚ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ç¼–è¾‘å™¨æ¥ç¡®ä¿å®ƒä»¬èƒ½æ­£ç¡®å¤„ç†æ–‡æœ¬å—ï¼Œè¿˜æœ‰å°±æ˜¯é¿å…ä½¿ç”¨é”™è¯¯çš„ç¼©è¿›ã€‚


## åŒ…å«æœ‰ç”¨ä¿¡æ¯çš„ç©ºæŒ‡é’ˆå¼‚å¸¸

**å¼€å§‹æ”¯æŒç‰ˆæœ¬ï¼š**[`JDK 15`](https://bugs.openjdk.java.net/browse/JDK-8233014) ([`JDK 14`](https://openjdk.java.net/jeps/358) ä¸­ä½¿ç”¨ `-XX:+ShowCodeDetailsInExceptionMessages` å¼€å¯)

è¿™ä¸ªç‰¹æ€§ä¸èƒ½ç®—åšçœŸæ­£æ„ä¹‰çš„è¯­è¨€ç‰¹æ€§ï¼Œä½†å®ƒå¾ˆæ£’ä»¥è‡³äºæˆ‘æƒ³å°†å®ƒåŠ åˆ°è¿™ä»½æ¸…å•ä¸­ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œé‡åˆ°ä¸€ä¸ª `NullPointerException` æ˜¯è¿™æ ·çš„ï¼š

```java
node.getElementsByTagName("name").item(0).getChildNodes().item(0).getNodeValue();

Exception in thread "main" java.lang.NullPointerException
        at Unlucky.method(Unlucky.java:83)
```

è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¼‚å¸¸ä¿¡æ¯ä¸­å¾ˆéš¾çœ‹å‡ºæ˜¯å“ªä¸ªæ–¹æ³•è¿”å›äº†ç©ºã€‚å› æ­¤å¾ˆå¤šå¼€å‘è€…å¸¸å¸¸å°†è¿™æ ·çš„è¯­å¥æ”¹å†™ä¸ºå¤šè¡Œï¼Œæ¥æ’æŸ¥åˆ°åº•æ˜¯å“ªä¸€è¡Œä»£ç å¯¼è‡´äº†ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚

ä» Java 15 å¼€å§‹ï¼Œå†ä¹Ÿæ²¡å¿…è¦è¿™æ ·åšäº†ï¼ŒNPE ä¼šæè¿°å‡ºè¿™æ¡è¯­å¥çš„å“ªä¸ªéƒ¨åˆ†ä¸ºç©ºã€‚ï¼ˆåœ¨ Java 14 ä¸­ä½ ä¹Ÿå¯ä»¥é€šè¿‡ `-XX:+ShowCodeDetailsInExceptionMessages` æ ‡è®°æ¥å¼€å¯è¿™ä¸ªç‰¹æ€§ï¼‰

```
Exception in thread "main" java.lang.NullPointerException:
  Cannot invoke "org.w3c.dom.Node.getChildNodes()" because
  the return value of "org.w3c.dom.NodeList.item(int)" is null
        at Unlucky.method(Unlucky.java:83)
```

ï¼ˆ[å‚çœ‹ Github ä¸Šè¿™ä¸ªç¤ºä¾‹é¡¹ç›®](https://github.com/dodie/java-tutorials/tree/master/java-helpful-npe-demo)ï¼‰

è¯¦ç»†çš„ä¿¡æ¯åŒ…å«äº†ä¸èƒ½è¢«æ‰§è¡Œçš„æ­¥éª¤ï¼ˆæ— æ³•è°ƒç”¨ `getChildNodes`ï¼‰ï¼ŒåŠå…¶å¤±è´¥åŸå› ï¼ˆ`item(int)` ä¸ºç©ºï¼‰ï¼Œè¿™å¤§å¤§ç®€åŒ–äº†å®šä½é—®é¢˜æ ¹æºã€‚

æ€»ä½“ä¸Šæ¥è¯´ï¼Œ**è¿™ä¸ªç‰¹æ€§æœ‰åŠ©äºè°ƒè¯•ï¼ŒåŒæ ·ä¹Ÿå¯¹ä»£ç å¯è¯»æ€§æœ‰æå‡**ï¼Œä»æ­¤ä½ åˆå¤±å»äº†ä¸€ä¸ªç‰ºç‰²ä»£ç å¯è¯»æ€§çš„æŠ€æœ¯åŸå› ã€‚

æœ‰ç”¨ä¿¡æ¯çš„ç©ºæŒ‡é’ˆå¼‚å¸¸æ‰©å±•æ˜¯åœ¨ JVM å±‚é¢å®ç°çš„ï¼Œè¿™ä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä½¿ä½ çš„ä»£ç ç¼–è¯‘ä¸ºè¾ƒè€çš„ Java ç‰ˆæœ¬ä¹ŸåŒæ ·èƒ½å—ç›Šï¼Œè€Œä¸”å½“ä½ ä½¿ç”¨å…¶å®ƒ JVM è¯­è¨€ï¼Œä¾‹å¦‚ Scala æˆ– Kotlin ä¹Ÿä¸€æ ·ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ**å¹¶éæ‰€æœ‰çš„ç©ºæŒ‡é’ˆå¼‚å¸¸éƒ½èƒ½å¾—åˆ°è¿™äº›é¢å¤–çš„ä¿¡æ¯ï¼Œä»…ä»…æ˜¯è¢« JVM åˆ›å»ºå¹¶æŠ›å‡ºçš„æ‰è¡Œ**ï¼š

- è¯»å–æˆ–å†™å…¥ä¸€ä¸ªæˆå‘˜å˜é‡ä¸ºç©ºæ—¶
- è°ƒç”¨ä¸€ä¸ªæ–¹æ³•ä¸ºç©ºæ—¶
- è·å–æˆ–èµ‹å€¼ä¸€ä¸ªæ•°ç»„å…ƒç´ ä¸ºç©ºæ—¶ï¼ˆç´¢å¼•ä¿¡æ¯**ä¸åœ¨**é”™è¯¯ä¿¡æ¯ä¸­ï¼‰
- [åŒ…è£…ç±»å¼€ç®±](https://docs.oracle.com/javase/tutorial/java/data/autoboxing.html) ä¸ºç©ºæ—¶

å¦å¤–å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªç‰¹æ€§**ä¸æ”¯æŒåºåˆ—åŒ–**ã€‚æ¯”å¦‚ï¼Œå½“ä¸€ä¸ªç©ºæŒ‡é’ˆå¼‚å¸¸è¢«é€šè¿‡ RMI æ–¹å¼çš„è¿œç¨‹è°ƒç”¨ï¼Œå¼‚å¸¸ä¿¡æ¯é‡Œä¸ä¼šåŒ…å«æœ‰ç”¨ä¿¡æ¯ã€‚

å½“å‰**æœ‰ç”¨ä¿¡æ¯çš„ç©ºæŒ‡é’ˆè¿™ä¸€ç‰¹æ€§é»˜è®¤å…³é—­**ï¼Œå¿…é¡»åŠ ä¸Š `-XX:+ShowCodeDetailsInExceptionMessages` æ ‡è®°æ¥æ‰‹åŠ¨å¼€å¯ã€‚

### âš ï¸ æç¤ºï¼šæ£€æŸ¥ä½ çš„å·¥å…·é“¾ {#tip-check-your-tooling}

å½“ä½ å‡çº§åˆ° Java 15 æ—¶ï¼Œæ£€æŸ¥ä½ çš„åº”ç”¨å’ŒåŸºç¡€è®¾æ–½å¹¶ç¡®ä¿ä»¥ä¸‹å‡ ç‚¹ï¼š

- å¤§å°å†™æ•æ„Ÿåˆ°å˜é‡å‘½åä¸ä¼šå‡ºç°åœ¨æ—¥å¿—æ–‡ä»¶å’Œç½‘é¡µæœåŠ¡å™¨å“åº”ä¸­
- æ—¥å¿—åˆ†æå·¥å…·èƒ½å¤„ç†æ–°çš„æ¶ˆæ¯æ ¼å¼
- æ„å»ºé¢å¤–ç»†èŠ‚çš„é¢å¤–å¼€é”€æ˜¯æœ‰å¿…è¦çš„


## Switch è¡¨è¾¾å¼

**å¼€å§‹æ”¯æŒç‰ˆæœ¬ï¼š** [`JDK 14`](https://openjdk.java.net/jeps/361) ([`JDK 12`](https://openjdk.java.net/jeps/325) [`JDK 13`](https://openjdk.java.net/jeps/354) ä¸­ä¸ºé¢„è§ˆç‰¹æ€§)

ä¹…è¿œçš„ `switch` å…³é”®å­—åœ¨ Java 14 ä¸­è·å¾—äº†ä¸€æ¬¡å¤§æå‡ã€‚Java åœ¨ä¿æŒæ”¯æŒä¹…çš„ [switch è¯­å¥](https://docs.oracle.com/javase/tutorial/java/nutsandbolts/switch.html) åŠŸèƒ½ç‰¹æ€§çš„åŒæ—¶ï¼Œä¹Ÿæ·»åŠ äº† **swith è¡¨è¾¾å¼**[^6]çš„è¯­æ³•æ”¯æŒï¼š

```java
int numLetters = switch (day) {
    case MONDAY, FRIDAY, SUNDAY -> 6;
    case TUESDAY                -> 7;
    default      -> {
        String s = day.toString();
        int result = s.length();
        yield result;
    }
};
```

æœ€é‡å¤§çš„å·®åˆ«æ˜¯ï¼Œè¿™ä¸ªæ–°çš„è¯­æ³•å½¢å¼**èƒ½ä½œä¸ºè¡¨è¾¾å¼ä½¿ç”¨**ã€‚ä»ä¸Šé¢çš„ä¾‹å­ä¸­å¯è§ï¼Œè¿™å¯ç”¨äºå˜é‡èµ‹å€¼ï¼Œä¸”å¯ä»¥ç”¨åœ¨ä»»ä½•æ¥å—è¡¨è¾¾å¼çš„åœ°æ–¹ï¼š

```java
int k = 3;
System.out.println(
    switch (k) {
        case  1 -> "one";
        case  2 -> "two";
        default -> "many";
    }
);
```

ç„¶è€Œï¼Œswitch è¡¨è¾¾å¼å’Œ switch è¯­å¥ä¹‹é—´å­˜åœ¨ä¸€äº›ç»†å¾®çš„å·®åˆ«ã€‚

é¦–å…ˆï¼Œswitch è¡¨è¾¾å¼**ä¸å­˜åœ¨å‡»ç©¿ï¼ˆfall-throughï¼‰çš„æƒ…å†µ**ã€‚è¿™æ ·å†ä¹Ÿä¸ä¼šå› ç¼ºå¤± `break` å…³é”®å­—è€Œäº§ç”Ÿç¼ºé™·äº†ã€‚ä¸ºäº†é¿å…æœ‰ä½¿ç”¨å‡»ç©¿çš„éœ€æ±‚ï¼Œ**æ¯ä¸ª `case` å¯ä»¥å®šä¹‰å¤šä¸ªå¸¸é‡**ï¼Œä»¥é€—å·åˆ†å‰²ã€‚

å…¶æ¬¡ï¼Œæ¯ä¸€ä¸ª `case` **æœ‰å…¶è‡ªå·±çš„ä½œç”¨åŸŸ**ã€‚

```java
String s = switch (k) {
    case  1 -> {
        String temp = "one";
        yield temp;
    }
    case  2 -> {
        String temp = "two";
        yield temp;
    }
    default -> "many";
}
```

æ¯ä¸ªåˆ†æ”¯è¦ä¹ˆæ˜¯ä¸€æ¡å•ç‹¬çš„è¡¨è¾¾å¼ï¼Œè¦ä¹ˆæ˜¯ç”±åŒ…è£¹åœ¨ä¸€ä¸ªè¯­å—ä¸­çš„å¤šæ¡è¯­å¥ç»„æˆã€‚

å†è€…ï¼Œ**switch è¡¨è¾¾å¼å¿…é¡»æ¶µç›–æ‰€æœ‰çš„åˆ†æ”¯æ¡ä»¶**ã€‚è¿™å°±æ„å‘³ç€å¯¹äºå­—ç¬¦ä¸²ç±»å‹ã€åŸºæœ¬ç±»å‹ä»¥åŠå®ƒä»¬çš„åŒ…è£…ç±»æ¥è¯´ï¼Œ`default` çš„æƒ…å†µå¿…é¡»æŒ‡æ˜ã€‚

```java
int k = 3;
String s = switch (k) {
    case  1 -> "one";
    case  2 -> "two";
    default -> "many";
}
```

å¯¹äºæšä¸¾çš„è¯ï¼Œè¦ä¹ˆ `defualt` éœ€è¦å£°æ˜ï¼Œè¦ä¹ˆæ˜¾å¼çš„å£°æ˜å‡ºæ‰€æœ‰æƒ…å†µã€‚åè€…çš„è¯æ˜¯æœ€ä½³å®è·µï¼Œèƒ½ç¡®ä¿æ‰€æœ‰çš„å€¼éƒ½è¢«è€ƒè™‘åˆ°äº†ã€‚å½“ç»™æšä¸¾ä¸­æ·»åŠ ä¸€ä¸ªæ–°å€¼æ—¶ï¼Œç”¨åˆ°å®ƒä½œä¸º switch è¡¨è¾¾å¼çš„åœ°æ–¹éƒ½ä¼šæŠ¥å‡ºç¼–è¯‘é”™è¯¯ã€‚

```java
enum Day {
   MONDAY, TUESDAY, WEDNESDAY, THURSDAY, FRIDAY, SATURDAY, SUNDAY
}

Day day = Day.TUESDAY;
switch (day) {
    case  MONDAY -> ":(";
    case  TUESDAY, WEDNESDAY, THURSDAY -> ":|";
    case  FRIDAY -> ":)";
    case  SATURDAY, SUNDAY -> ":D";
}
```

é‰´äºä»¥ä¸Šæ‰€æœ‰åŸå› ï¼Œæ›´åå‘äºä½¿ç”¨ switch è¡¨è¾¾å¼è€Œä¸æ˜¯ switch è¯­å¥ï¼Œèƒ½åˆ©äºäº§å‡ºæ›´å¤šå¯ç»´æŠ¤çš„ä»£ç ã€‚

### âš ï¸ æç¤ºï¼šä½¿ç”¨ç®­å¤´è¯­æ³• {#tip-use-arrow-syntax}

switch è¡¨è¾¾å¼ä¸­ `case` ä¸ä»…èƒ½ä½¿ç”¨ç±»ä¼¼äº lambda è¡¨è¾¾å¼ä¸­ç®­å¤´å½¢å¼ï¼Œè¿˜èƒ½é…åˆ `yeild` å…³é”®å­—**ä½¿ç”¨ç±»ä¼¼äºä»¥å¾€ switch è¯­å¥ä¸­çš„å†’å·å½¢å¼**ï¼š

```java
int result = switch (s) {
    case "foo":
    case "bar":
        yield 2;
    default:
        yield 3;
};
```

è¿™ç§å½¢å¼ä¹Ÿèƒ½è¢«ç”¨ä½œä¸€ä¸ªè¡¨è¾¾å¼ï¼Œä½†è¿™æ›´ç±»ä¼¼äºä»¥å¾€çš„ switch è¯­å¥ï¼Œå› ä¸ºï¼š

- å‡»ç©¿
- æ‰€æœ‰åˆ†æ”¯å…±äº«ä¸€ä¸ªä½œç”¨åŸŸ

æˆ‘çš„æ„è§ï¼Ÿä¸è¦ä½¿ç”¨è¿™ç§å½¢å¼ï¼Œè€Œæ˜¯ä½¿ç”¨ç®­å¤´å½¢å¼çš„ switch è¡¨è¾¾å¼ï¼Œè¿™æ ·èƒ½è·å–æ‰€æœ‰å¥½å¤„ã€‚


## å±€éƒ¨å˜é‡ç±»å‹æ¨æ–­

**å¼€å§‹æ”¯æŒç‰ˆæœ¬ï¼š** [`JDK 11`](https://openjdk.java.net/jeps/323) ([`JDK 10`](https://openjdk.java.net/jeps/286) Lambda ä¸­ä¸æ”¯æŒ)

è‡ªä» Java 8 ä¹‹åæœ€æ˜¾è‘—çš„è¯­è¨€ç‰¹æ€§æ”¹è¿›å¯èƒ½æ˜¯ `var` å…³é”®å­—ã€‚è¿™æœ€åˆæ˜¯åœ¨ [Java 10](https://openjdk.java.net/jeps/286) ä¸­å¼•å…¥çš„ï¼Œéšååœ¨ [Java 11](https://openjdk.java.net/jeps/323) ä¸­å¾—åˆ°è¿›ä¸€æ­¥æ”¹è¿›ã€‚

é€šè¿‡çœç•¥æ˜¾å¼çš„ç±»å‹å£°æ˜ï¼Œè¿™ä¸ªç‰¹æ€§å¸®åŠ©æˆ‘ä»¬ç®€åŒ–äº†å±€éƒ¨å˜é‡å£°æ˜çš„ç¹æ–‡ç¼›èŠ‚ï¼š

```java
var greetingMessage = "Hello!";
```

è™½ç„¶çœ‹èµ·æ¥åƒ Javascript ä¸­çš„ `var` å…³é”®å­—ï¼Œä½†è¿™**å¹¶éæ˜¯åŠ¨æ€ç±»å‹**ã€‚

æ¥çœ‹ä¸‹è¿™æ®µæ¥è‡ª JEP çš„å¼•è¿°ï¼š

> æˆ‘ä»¬æ—¨åœ¨ç®€åŒ– Java ä»£ç ç¼–å†™ä¸­çš„ç¹æ–‡ç¼›èŠ‚ï¼Œæ¥æå‡å¼€å‘è€…çš„ç¼–ç¨‹ä½“éªŒï¼Œå¹¶ä¿æŒ Java ä½œä¸ºé™æ€ç±»å‹å®‰å…¨è¯­è¨€çš„æ‰¿è¯ºã€‚

å£°æ˜å˜é‡çš„ç±»å‹æ˜¯**åœ¨ç¼–è¯‘æ—¶æ¨æ–­çš„**ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­å…¶ç±»å‹æ˜¯å­—ç¬¦ä¸²ã€‚ä½¿ç”¨ `var` è€Œä¸æ˜¯æ˜¾å¼çš„ç±»å‹ï¼Œèƒ½ä½¿è¿™å—ä»£ç ä¸é‚£ä¹ˆè‡ƒè‚¿ï¼Œä¹Ÿæ›´æ˜“è¯»ã€‚

è¿™æ˜¯å¦ä¸€ä¸ªç±»å‹æ¨æ–­èƒ½å‘æŒ¥ä¼˜åŠ¿çš„ä¾‹å­ï¼š

```java
MyAwesomeClass awesome = new MyAwesomeClass();
```

åœ¨å¾ˆå¤šçš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªç‰¹æ€§ç¡®å®èƒ½æå‡ä»£ç è´¨é‡ã€‚ä½†æœ‰æ—¶å€™ç»§ç»­ä½¿ç”¨æ˜¾å¼çš„ç±»å‹å£°æ˜åè€Œæ˜¯æ›´æ¨å´‡çš„ã€‚æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªä½¿ç”¨ `var` æ›¿æ¢ç±»å‹å£°æ˜å¯¼è‡´é—®é¢˜çš„ä¾‹å­ã€‚

### âš ï¸ æç¤ºï¼šæ—¶åˆ»è€ƒè™‘å¯è¯»æ€§ {#tip-keep-readability-in-mind}

ç¬¬ä¸€ä¸ªæƒ…å½¢æ˜¯ï¼Œå½“åœ¨æºç ä¸­ç§»é™¤æ˜¾å¼çš„ç±»å‹ä¿¡æ¯ï¼Œä¼šå½±å“å¯è¯»æ€§ã€‚

å½“ç„¶ï¼ŒIDE èƒ½åœ¨è¿™æ–¹é¢èµ·åˆ°ä¸€å®šå¸®åŠ©ï¼Œä½†æ˜¯åœ¨ä»£ç è¯„å®¡ï¼Œæˆ–å¿«é€Ÿæµè§ˆä»£ç æ—¶è¿™å°±ä¼šæœ‰å½±å“ã€‚ä¾‹å¦‚ï¼Œåœ¨å·¥å‚æ¨¡å¼æˆ–æ„é€ è€…æ¨¡å¼ä¸­ï¼Œä½ ä¸å¾—ä¸æ‰¾åˆ°è´Ÿè´£æ„å»ºå¯¹è±¡çš„ä»£ç ï¼Œæ‰èƒ½æ¨æ–­å‡ºå…¶ç±»å‹ã€‚

æ¥ç‚¹å°æµ‹è¯•ï¼Œä¸‹é¢çš„ä»£ç ç‰‡æ®µä½¿ç”¨äº† Java 8 ä¸­çš„æ—¥æœŸæ—¶é—´ APIï¼ŒçŒœä¸‹è¿™äº›å˜é‡çš„ç±»å‹ï¼š

```java
var date = LocalDate.parse("2019-08-13");
var dayOfWeek = date.getDayOfWeek();
var dayOfMonth = date.getDayOfMonth();
```

çŒœå®Œäº†å—ï¼Ÿè¿™æ˜¯ç­”æ¡ˆï¼š

ç¬¬ä¸€ä¸ªå˜é‡ååˆ†ç›´è§‚ï¼Œ`parse` æ–¹æ³•è¿”å›äº† `LocalDate` å¯¹è±¡ã€‚ç„¶è€Œï¼Œæ¥ä¸‹æ¥ä¸¤ä¸ªï¼Œä½ éœ€è¦å¯¹ API æ›´äº†è§£ï¼š `dayOfWeek` æ–¹æ³•è¿”å›çš„æ˜¯ `java.time.DayOfWeek`ï¼Œä½† `dayOfMonth` ä»…ä»…æ˜¯è¿”å›äº† `int`ã€‚

è¿˜æœ‰ä¸ªæ½œåœ¨é—®é¢˜ï¼Œé‡åˆ° `var` æ—¶ï¼Œä»£ç é˜…è¯»è€…ä¸å¾—ä¸æ›´ä¾èµ–äºä¸Šä¸‹æ–‡ã€‚æƒ³è±¡ä¸‹è¿™ä¸ªä¾‹å­ï¼š

```java
private void longerMethod() {
    // ...
    // ...
    // ...

    var dayOfWeek = date.getDayOfWeek();

    // ...
    // ...
    // ...
}
```

åŸºäºä¹‹å‰å¯¹ä¾‹å­ï¼Œä½ å¯èƒ½ä¼šçŒœæ˜¯ `java.time.DayOfWeek` ã€‚ä½†è¿™ä¸ªä¾‹å­ä¸­çš„ `date` å¯¹è±¡æ˜¯ Joda åº“ä¸­çš„ï¼Œæ‰€ä»¥è¿”å›çš„æ˜¯æ•´å‹ã€‚è¿™æ˜¯ä¸ªä¸åŒçš„ APIï¼ŒåŒæ ·çš„æ–¹æ³•ä½†æœ‰æ‰€å·®æ± ï¼Œåœ¨è¾ƒé•¿çš„æ–¹æ³•ä½“ä¸­ï¼Œè‹¥æ²¡çœ‹å®Œæ¯è¡Œä»£ç ï¼Œä¼šå¯¼è‡´ä½ çœ‹ä¸å‡ºå·®å¼‚ã€‚(JavaDoc: [Joda time](https://www.joda.org/joda-time/apidocs/org/joda/time/ReadableDateTime.html#getDayOfWeek--) / [Java 8 Date/Time API](https://docs.oracle.com/javase/8/docs/api/java/time/LocalDate.html#getDayOfWeek--))

å¦‚æœè¿™å„¿æœ‰æ˜¾å¼çš„ç±»å‹å£°æ˜ï¼Œå¼„æ¸… `dayOfWeek` å¯¹è±¡æ˜¯ä»€ä¹ˆç±»å‹å°±å¾ˆå®¹æ˜“ã€‚ç°åœ¨æœ‰äº† `var` ï¼Œè¯»è€…é¦–å…ˆå¾—æ‰¾å‡º `date` å¯¹è±¡çš„ç±»å‹ï¼Œè¿˜è¦ææ¸… `getDayOfWeek` æ–¹æ³•åšäº†ä»€ä¹ˆã€‚è¦æ˜¯æœ‰ä¸€ä¸ª IDEï¼Œè¿™ä¸€åˆ‡éƒ½å¾ˆè½»æ¾ï¼Œä½†æ˜¯ä»…ä»…æ˜¯å¿«é€Ÿæµè§ˆä»£ç ï¼Œè¿™å°±æ²¡é‚£ä¹ˆå®¹æ˜“äº†ã€‚

### âš ï¸ æç¤ºï¼šæ³¨æ„ä¿ç•™é‡è¦çš„ç±»å‹ä¿¡æ¯ {#tip-pay-attention-to-preserve-important-type-infomation}

ç¬¬äºŒä¸ªæƒ…å½¢æ˜¯ï¼Œä½¿ç”¨ `var` æ¶ˆé™¤äº†æ‰€æœ‰å¯ç”¨çš„ç±»å‹ä¿¡æ¯ï¼Œç”šè‡³å¯¼è‡´æ— æ³•è¢«æ¨æ–­ã€‚åœ¨ç»å¤§å¤šæ•°æƒ…å½¢ä¸‹ï¼Œè¿™äº›é—®é¢˜èƒ½è¢« Java ç¼–è¯‘å™¨æ•è·ã€‚æ¯”å¦‚ï¼Œ`var` ä¸èƒ½é’ˆå¯¹ lambda å’Œæ–¹æ³•å¼•ç”¨è¿›è¡Œæ¨æ–­ï¼Œå› ä¸ºç¼–è¯‘å™¨ä¾èµ–äºè¡¨è¾¾å¼å·¦è¾¹çš„å£°æ˜æ¥ç¡®å®šç±»å‹ã€‚

ç„¶è€Œï¼Œå­˜åœ¨ä¸€äº›ä¾‹å¤–æƒ…å†µã€‚ä¾‹å¦‚ï¼Œ`var` ä¸èƒ½å’Œé’»çŸ³è¿ç®—ç¬¦å¾ˆå¥½çš„æ­é…ä½¿ç”¨ï¼Œåè€…èƒ½ç§»é™¤åœ¨åˆ›å»ºæ³›å‹å¯¹è±¡æ—¶å³ä¾§è¡¨è¾¾å¼å†—é•¿çš„è¯­æ³•ï¼š

```java
Map<String, String> myMap = new HashMap<String, String>(); // Pre Java 7
Map<String, String> myMap = new HashMap<>(); // Using Diamond operator
```

ç”±äºé’»çŸ³æ“ä½œç¬¦ä»…å’Œæ³›å‹æœ‰å…³ï¼Œè¿™å°±è¿˜æœ‰è¯­æ³•ä¸Šçš„å†—ä½™èƒ½è¢«ç§»é™¤ã€‚æˆ‘ä»¬æ¥ç”¨ `var` å…³é”®å­—ä½¿å®ƒçœ‹èµ·æ¥æ›´ç®€æ´ï¼š

```java
var myMap = new HashMap<>();
```

è¿™ä¸ªä¾‹å­è¯­æ³•ä¸Šæ˜¯å¯è¡Œçš„ï¼Œåœ¨ Java 11 ä¸­ç¼–è¯‘å™¨ç”šè‡³ä¸ä¼šæŠ¥å‡ºè­¦å‘Šã€‚ç„¶è€Œï¼Œæˆ‘ä»¬å®Œå…¨ä¸æŒ‡å®šæ³›å‹ç±»å‹ï¼Œç±»å‹æ¨æ–­ä¼šç»™å‡º `Map<Object, Object>` çš„ç»“æœã€‚

å½“ç„¶ï¼Œæˆ‘ä»¬èƒ½æ›¿æ¢æ‰é’»çŸ³æ“ä½œç¬¦æ¥è½»æ¾çš„è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

```java
var myMap = new HashMap<String, String>();
```

`var` å’ŒåŸºç¡€ç±»å‹ä½¿ç”¨çš„æ—¶å€™è¿˜æœ‰å¦ä¸€ç³»åˆ—é—®é¢˜ï¼š

```java
byte   b = 1;
short  s = 1;
int    i = 1;
long   l = 1;
float  f = 1;
double d = 1;
```

åœ¨æ²¡æœ‰æ˜¾å¼ç±»å‹å£°æ˜çš„æƒ…å†µä¸‹ï¼Œä¸Šé¢çš„æ‰€æœ‰å˜é‡éƒ½ä¼šè¢«æ¨æ–­ä¸ºæ•´å‹ã€‚åœ¨å¤„ç†åŸºæœ¬ç±»å‹æ—¶ï¼Œè¦ä¹ˆä½¿ç”¨ç±»å‹å­—é¢é‡ï¼ˆæ¯”å¦‚ `1L`ï¼‰ï¼Œè¦ä¹ˆå°±å®Œå…¨é¿å…ä½¿ç”¨ `var` ã€‚

### âš ï¸ æç¤ºï¼šç¡®ä¿é˜…è¯»å®˜æ–¹çš„ä»£ç é£æ ¼æŒ‡å— {#tip-make-sure-to-read-the-official-style-guides}

ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ç±»å‹æ¨æ–­å®Œå…¨å–å†³äºä½ ï¼Œä½†ç¡®ä¿å®ƒä¸ä¼šå½±å“å¯è¯»æ€§å’Œæ­£ç¡®æ€§ã€‚ç»éªŒä¹‹è°ˆï¼Œä¿æŒä¸€ä¸ªè‰¯å¥½çš„ç¼–ç¨‹å®è·µï¼Œæ¯”å¦‚ä¸é”™çš„å‘½åå’Œç¼©å°å±€éƒ¨å˜é‡çš„ä½œç”¨åŸŸè‚¯å®šæ˜¯å¾ˆæœ‰å¸®åŠ©çš„ã€‚ç¡®ä¿é˜…è¯»å®˜æ–¹é’ˆå¯¹ `var` çš„[ä»£ç é£æ ¼æŒ‡å—](https://openjdk.java.net/projects/amber/LVTIstyle.html)å’Œ[å¸¸è§é—®é¢˜](https://openjdk.java.net/projects/amber/LVTIFAQ.html)ã€‚

ç”±äº `var` æœ‰å¾ˆå¤šå‘ï¼Œæœ€å¥½åœ¨æŠŠå®ƒå¼•å…¥åˆ°ä»£ç ä¸­æ—¶ä¿å®ˆäº›ï¼Œä¹Ÿä»…ä»…åœ¨å±€éƒ¨å˜é‡ä¸­ä½¿ç”¨å®ƒï¼Œè¿™æ ·å®ƒçš„ä½œç”¨åŸŸä¹Ÿååˆ†å±€é™ã€‚

åŒæ—¶ï¼Œåœ¨å¼•å…¥æ—¶ä¹Ÿå°½é‡è°¨æ…äº›ï¼Œ**`var` ä¸æ˜¯ä¸€ä¸ªæ–°çš„å…³é”®å­—ï¼Œè€Œæ˜¯ä¸€ä¸ªä¿ç•™ç±»å**ã€‚è¿™æ„å‘³ç€å½“ç”¨ä½œç±»åæ—¶æœ‰ç‰¹æ®Šå«ä¹‰ï¼Œåœ¨ä»»ä½•åœ°æ–¹å…¶éƒ½ä½œä¸ºåˆæ³•çš„å¼•ç”¨ã€‚

å½“å‰ï¼Œ`var` è¿˜æ²¡æœ‰ç›¸åº”çš„å•ä¸€ã€Œå…³é”®å­—ã€æ¥å£°æ˜ä¸å¯å˜å˜é‡ï¼ˆæ¯”å¦‚ `val` æˆ– `const`ï¼‰ã€‚å¸Œæœ›æœªæ¥çš„ç‰ˆæœ¬ä¸­ä¼šæ”¯æŒï¼Œåœ¨é‚£ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `final var` ã€‚

å‚è€ƒæ¥æºï¼š

- [First Contact With â€˜varâ€™ In Java 10](https://blog.codefx.org/java/java-10-var-type-inference/)
- [26 Items for Dissecting Java Local Variable Type Inference (Var Type)](https://dzone.com/articles/var-work-in-progress)
- [Java 10: Local Variable Type Inference](https://www.journaldev.com/19871/java-10-local-variable-type-inference)


## æ¥å£ä¸­å…è®¸ç§æœ‰æ–¹æ³•

**å¼€å§‹æ”¯æŒç‰ˆæœ¬ï¼š** [JDK 9](https://openjdk.java.net/jeps/213) ([Milling Project Coin](https://openjdk.java.net/jeps/213))

ä» Java 8 å¼€å§‹ï¼Œåœ¨æ¥å£ä¸­æ·»åŠ é»˜è®¤æ–¹æ³•æˆä¸ºå¯èƒ½ã€‚åˆ° Java 9 ä¸­ï¼Œé»˜è®¤æ–¹æ³•ç”šè‡³èƒ½è°ƒç”¨ç§æœ‰æ–¹æ³•ï¼Œè¿™æ—¢æ»¡è¶³ä»£ç å¤ç”¨çš„éœ€æ±‚ï¼Œä½†åˆä¸å¯¹å¤–æš´éœ²ç›¸åº”é€»è¾‘ã€‚

è™½ç„¶è¿™ä¸æ˜¯ä¸ªå¤§çš„æ”¹è¿›ï¼Œä½†è¿™å¯¹æ•´ç†é»˜è®¤æ–¹æ³•ä¸­çš„ä»£ç å°æœ‰å¸®åŠ©ã€‚


## åŒ¿åå†…éƒ¨ç±»çš„é’»çŸ³æ“ä½œç¬¦

**å¼€å§‹æ”¯æŒç‰ˆæœ¬ï¼š** [JDK 9](https://openjdk.java.net/jeps/213) ([Milling Project Coin](https://openjdk.java.net/jeps/213))

Java 7 å¼•å…¥äº†é’»çŸ³æ“ä½œç¬¦ï¼ˆ`<>`ï¼‰æ¥å‡å°‘å†—ä½™ï¼Œè¿™æ˜¯é€šè¿‡è®©ç¼–è¯‘å™¨æ¨æ–­æ„é€ æ–¹æ³•çš„å‚æ•°ç±»å‹å®ç°çš„ï¼š

```java
List<Integer> numbers = new ArrayList<>();
```

ç„¶è€Œï¼Œè¿™ä¸ªç‰¹æ€§ä¹‹å‰å¹¶ä¸æ”¯æŒåŒ¿åå†…éƒ¨ç±»ã€‚æ ¹æ® [JDK é¡¹ç›®çš„é‚®ä»¶åˆ—è¡¨è®¨è®º](https://mail.openjdk.java.net/pipermail/coin-dev/2011-June/003283.html)æ¥çœ‹ï¼Œé’»çŸ³æ“ä½œç¬¦ä¸€å¼€å§‹æ²¡æœ‰æ·»åŠ æ­¤ç‰¹æ€§æ˜¯ç”±äºè¿™éœ€è¦ JVM å±‚é¢è¾ƒå¤§çš„æ”¹åŠ¨ã€‚

åˆ° Java 9 æ—¶ï¼Œè¿™ä¸ªå°å°çš„ç—›ç‚¹å·²è¢«è§£å†³ï¼Œé’»çŸ³æ“ä½œç¬¦æ›´åŠ çš„é€šç”¨ï¼š

```java
List<Integer> numbers = new ArrayList<>() {
    // ...
}
```


## try-with-resources è¯­å¥ä¸­å…è®¸ä½¿ç”¨ effectively-final å˜é‡

**å¼€å§‹æ”¯æŒç‰ˆæœ¬ï¼š** [JDK 9](https://openjdk.java.net/jeps/213) ([Milling Project Coin](https://openjdk.java.net/jeps/213))

Java 7 å¸¦æ¥äº†å¦ä¸€ä¸ªè¯­æ³•å¢å¼ºï¼š`try-with-resources` ï¼Œå¸®åŠ©å¼€å‘è€…è§£å†³æ€»æ˜¯æ‹…å¿ƒé‡Šæ”¾èµ„æºçš„é—®é¢˜ã€‚

ä¸ºå±•ç¤ºå®ƒçš„å¨åŠ›ï¼Œå…ˆçœ‹ä¸€ä¸ªå…ˆäº Java 7 çš„æ­£ç¡®é‡Šæ”¾èµ„æºç¤ºä¾‹ï¼š

```java
BufferedReader br = new BufferedReader(...);
try {
    return br.readLine();
} finally {
    if (br != null) {
        br.close();
    }
}
```

ä½¿ç”¨ `try-with-resources` èƒ½è‡ªåŠ¨é‡Šæ”¾èµ„æºï¼Œä»£ç é‡è¿˜æ›´å°‘ï¼š

```java
try (BufferedReader br = new BufferedReader(...)) {
    return br.readLine();
}
```

å°½ç®¡å®ƒå¨åŠ›å¼ºå¤§ï¼Œä½†ä¹Ÿæœ‰çŸ­æ¿ï¼ŒJava 9 æ­£å¥½æ—¨åœ¨è§£å†³å®ƒä»¬ã€‚

å…´è®¸ä½ èƒ½ç”¨å®ƒæ¥å¤„ç†å¤šä¸ªèµ„æºï¼Œä½†å¾ˆå®¹æ˜“å°±ä¼šå¯¼è‡´ä»£ç å¯è¯»æ€§ä¸‹é™ã€‚åœ¨ `try` å…³é”®å­—åå£°æ˜ä¸€é•¿ä¸²å˜é‡ï¼Œè¿™ç¨ç¨æœ‰äº›è¿èƒŒå¸¸è§„çš„ Java ä»£ç ã€‚

```java
try (BufferedReader br1 = new BufferedReader(...);
    BufferedReader br2 = new BufferedReader(...)) {
    System.out.println(br1.readLine() + br2.readLine());
}
```

è¿˜æœ‰ï¼Œåœ¨ Java 7 ä¸­ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªå·²ç»å­˜åœ¨ä½†éœ€è¦æ”¾åˆ°è¿™ä¸ªç»“æ„ä¸­å¤„ç†çš„å˜é‡ï¼Œå°±ä¸å¾—ä¸å¼•å…¥ä¸€ä¸ªä¼ªå˜é‡ã€‚ï¼ˆçœ‹è¿™ä¾‹å­ï¼š[JDK-8068948](https://bugs.openjdk.java.net/browse/JDK-8068948)ï¼‰

ä¸ºå‡å°‘è¿™äº›è´Ÿé¢å½±å“ï¼Œ`try-with-resources` å¾—åˆ°äº†å¢å¼ºï¼Œé™¤äº†æ–°å»ºå˜é‡å¤–ï¼Œå¯ä»¥å¤„ç†ä¸å¯å˜æˆ–å®é™…ä¸å¯å˜çš„å±€éƒ¨å˜é‡ï¼š

```java
BufferedReader br1 = new BufferedReader(...);
BufferedReader br2 = new BufferedReader(...);
try (br1; br2) {
    System.out.println(br1.readLine() + br2.readLine());
}
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå˜é‡çš„åˆå§‹åŒ–å’Œå…¶æ³¨å†Œåˆ° `try-with-resources` ç»“æ„ä¸­çš„æ­¥éª¤å·²ç»åˆ†ç¦»å¼€ã€‚

### âš ï¸ æç¤ºï¼šå½“å¿ƒå·²é‡Šæ”¾çš„èµ„æº {#tip-watch-out-for-released-resources}

æœ‰ä¸€ç‚¹éœ€è¦è­¦æƒ•åœ¨å¿ƒï¼Œå·²è¢« `try-with-resources` é‡Šæ”¾çš„èµ„æºæ˜¯å¯èƒ½ä¼šè¢«å†æ¬¡å¼•ç”¨çš„ï¼Œä½†è¿™å‡ ä¹éƒ½ä¼šå¤±è´¥ï¼š

```java
BufferedReader br = new BufferedReader(...);
try (br) {
    System.out.println(br.readLine());
}
br.readLine(); // Boom!
```


## ä¸‹åˆ’çº¿ä¸å†æ˜¯åˆæ³•å˜é‡å

**å¼€å§‹æ”¯æŒç‰ˆæœ¬ï¼š** [JDK 9](https://openjdk.java.net/jeps/213) (Milling Project Coin)

[åœ¨ Java 8 ä¸­](https://bugs.java.com/bugdatabase/view_bug.do?bug_id=8005852)ï¼Œå˜é‡åä¸ºä¸‹åˆ’çº¿ï¼ˆ`_`ï¼‰æ—¶ç¼–è¯‘å™¨ä¼šæŠ›å‡ºè­¦å‘Šã€‚Java 9 æ›´è¿›ä¸€æ­¥ï¼Œå°†å•ä¸ªä¸‹åˆ’çº¿å­—ç¬¦è§†ä¸ºéæ³•å˜é‡åï¼Œä¿ç•™ç»™æœªæ¥ä½œä¸ºç‰¹æ®Šè¯­ä¹‰åšå‡†å¤‡ã€‚

æ³¨æ„ï¼šè¿™ä¸[åŒ¿åå˜é‡](#åŒ¿åæ¨¡å¼å’ŒåŒ¿åå˜é‡)ç›¸åº”å˜åŒ–ï¼Œè¿™æ˜¯ Java 21 ä¸­çš„é¢„è§ˆåŠŸèƒ½ï¼Œå…è®¸ä¸‹åˆ’çº¿ä»¥è¡¨è¾¾ç‰¹æ®Šå«ä¹‰ã€‚

```java
// Java 9+ ç¼–è¯‘é”™è¯¯
// é™¤éè¿è¡Œåœ¨ Java 21 å¹¶å¼€å¯é¢„è§ˆç‰¹æ€§
int _ = 10; 
```


## æ”¹è¿›çš„è­¦å‘Š

**å¼€å§‹æ”¯æŒç‰ˆæœ¬ï¼š** [JDK 9](https://openjdk.java.net/jeps/211)

æœ€åï¼Œæˆ‘ä»¬å†è¯´ç‚¹åœ¨è¾ƒæ–° Java ç‰ˆæœ¬ä¸­å…³äºç¼–è¯‘å™¨è­¦å‘Šçš„å˜åŒ–ã€‚

ç°åœ¨å¯ä»¥ç”¨ `@SafeVarargs` æ³¨è§£åœ¨ç§æœ‰æ–¹æ³•ä¸Šï¼Œä»¥æ ‡è®° `Type safety: Potential heap pollution via varargs parameter` è­¦å‘Šï¼ˆäº‹å®ä¸Šï¼Œè¿™ä¸ªå˜åŒ–æ˜¯å‰é¢è®¨è®ºè¿‡  [JEP 213: Milling Project Coin](https://openjdk.java.net/jeps/213) çš„ä¸€éƒ¨åˆ†ï¼‰ã€‚éœ€è¦äº†è§£æ›´å¤šå¯ä»¥å‚çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œ[å¯å˜å‚æ•°](https://docs.oracle.com/javase/8/docs/technotes/guides/language/varargs.html)ã€[æ³›å‹](https://docs.oracle.com/javase/8/docs/technotes/guides/language/generics.html)ä»¥åŠä¸¤è€…ç»“åˆ[å¯èƒ½äº§ç”Ÿçš„é—®é¢˜](https://docs.oracle.com/javase/tutorial/java/generics/nonReifiableVarargsType.html)ã€‚

è¿˜æœ‰ï¼Œè‡ªä» [Java 9](https://openjdk.java.net/jeps/211) ä»¥åï¼Œç¼–è¯‘å™¨ä¸å†ä¸ºå¼•å…¥åºŸå¼ƒçš„ç±»å‹æŠ¥å‡ºè­¦å‘Šã€‚å› ä¸ºè¿™äº›è­¦å‘Šå·²ç»åœ¨è°ƒç”¨çš„åœ°æ–¹å±•ç¤ºäº†ï¼Œæ‰€ä»¥æ²¡æœ‰å¤ªå¤šå®é™…æœ‰ä»·å€¼çš„ä¿¡æ¯ï¼Œä¹Ÿæ˜¾å¾—å†—ä½™ã€‚


## æ€»ç»“

è¿™ç¯‡æ–‡ç« ä»‹ç»äº† Java 8 ä»¥åçš„è¯­è¨€æ”¹è¿›ã€‚éšç€æ–°çš„æ¯ 6 ä¸ªæœˆä¸€æ¬¡çš„å¿«é€Ÿå‘å¸ƒå‘¨æœŸï¼Œæ›´å¤šçš„å˜åŒ–è¢«å¼•å…¥ï¼Œä¿æŒå…³æ³¨ Java å¹³å°çš„å˜åŒ–å°±æ›´åŠ é‡è¦äº†ã€‚


---

è¯‘è€…æ³¨ï¼š

[^1]: [JDK Enhancement Proposal](https://openjdk.java.net/jeps/0), JDK æ”¹è¿›æè®®ï¼ŒJDK çš„é‡å¤§ä¿®æ”¹/ç‰¹æ€§å‡ ä¹éƒ½ä»¥æ­¤æå‡ºï¼Œç±»ä¼¼äº ECMA çš„ [TC39 Proposal](https://github.com/tc39/proposals)ï¼›

[^2]: æ­¤ç¯‡æ–‡ç« ä¹Ÿæœ‰ç¿»è¯‘ï¼š[Java 9 åˆ° 16 çš„è¯­è¨€å’Œ JVM ç‰¹æ€§æ›´æ–°åˆ†ç±»æ¸…å•](https://nanova.me/posts/java-lang-jvm-updates)
[^3]: guardsï¼Œç¿»è¯‘å‚è€ƒï¼šhttps://en.wikipedia.org/wiki/Guard_(computer_science)
[^4]: è¯‘å½•ç±»çš„æ„é€ æ–¹æ³•æœ‰ï¼š*canonical constructor*ï¼ˆç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ç”Ÿæˆï¼‰ å’Œ *compact constructors*ï¼ˆæ²¡æœ‰å…¥å‚æ‹¬å·ï¼Œé»˜è®¤ä¼šè°ƒç”¨æ ‡å‡†æ„é€ æ–¹æ³•ï¼Œä¹Ÿä¼šæ²¿ç”¨å…¨éƒ¨çš„æˆå‘˜å˜é‡ä½œä¸ºå…¥å‚ï¼‰ ä»¥åŠ *alternative constructor*ï¼ˆå¯ä»¥è‡ªå®šä¹‰å…¥å‚ï¼Œå¿…é¡»å…ˆè°ƒç”¨å‰é¢ä¸¤ç§æ„é€ æ–¹æ³•ï¼‰ï¼Œå‚è€ƒï¼š[Records Come to Java (oracle.com)](https://blogs.oracle.com/javamagazine/records-come-to-java#anchor_4)
[^5]: è¿™é‡ŒæŒ‡çš„æ˜¯åŸæ–‡çš„å‚è€ƒæ¥æºï¼Œä¸‹åŒ
[^6]: statement å’Œ expression çš„åŒºåˆ«å‚è§ï¼šhttps://stackoverflow.com/questions/39523474/what-is-the-difference-between-an-expression-and-a-statement-in-java

